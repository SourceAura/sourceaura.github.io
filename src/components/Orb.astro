---
/*
Orb:
Plasma Orb - Petal
*/
import type { CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"petals">;
  type?: "text" | "audio" | "video" | "photo" | "project";
}

const { post } = Astro.props;

/* Extract first markdown image */
let imageSrc: string | null = null;

const match = post.body.match(/!\[.*?\]\((.*?)\)/);
if (match?.[1]) {
  const raw = match[1].trim();
  imageSrc =
    raw.startsWith("http") || raw.startsWith("/")
      ? raw
      : `/images/${raw.replace(/^\.?\//, "")}`;
}
---

<article
  class="orb-card"
  data-orb
  data-has-image={imageSrc ? "true" : "false"}
  data-seed={Math.floor(Math.random() * 1000)}
>
  <div class="orb-surface">
    <div class="orb-wrap">
      <svg
        viewBox="0 0 200 200"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <defs>
          <!-- Plasma filter -->
          <filter id="orbFX" x="0%" y="0%" width="100%" height="100%">
            <!-- 1. Base noise -->
            <feTurbulence
              type="fractalNoise"
              baseFrequency="0.015 0.019"
              numOctaves="2"
              seed="1"
              result="noise"></feTurbulence>

            <!-- 2. Rolling flow: animate baseFrequency, NOT seed -->
            <animate
              xlink:href="#orbFX feTurbulence"
              attributeName="baseFrequency"
              dur="37s"
              values="
                0.014 0.018;
                0.017 0.021;
                0.015 0.019;
                0.018 0.016;
                0.016 0.020
              "
              repeatCount="indefinite"></animate>

            <!-- 3. Directional drift -->
            <feOffset in="SourceGraphic" dx="0" dy="0" result="drifted">
              <animate
                attributeName="dx"
                dur="29s"
                values="0;6;2;9;4;11;7"
                repeatCount="indefinite"></animate>
              <animate
                attributeName="dy"
                dur="41s"
                values="0;3;8;1;10;5;12"
                repeatCount="indefinite"></animate>
            </feOffset>

            <!-- 4. Displace AFTER drift -->
            <feDisplacementMap
              in="drifted"
              in2="noise"
              scale="38"
              xChannelSelector="R"
              yChannelSelector="G"
              result="warped"></feDisplacementMap>

            <!-- 5. Light shaping -->
            <feColorMatrix
              in="warped"
              type="matrix"
              values="
                1.04 0    0    0   -0.02
                0    1.04 0    0   -0.02
                0    0    1.04 0   -0.02
                0    0    0    1    0
              "
              result="colored"></feColorMatrix>

            <feSpecularLighting
              in="colored"
              surfaceScale="1"
              specularConstant="0.32"
              specularExponent="22"
              lighting-color="rgb(var(--orb-glow))"
              result="light"
            >
              <fePointLight x="100" y="100" z="160"></fePointLight>
            </feSpecularLighting>

            <feComposite in="light" in2="colored" operator="in" result="lit"
            ></feComposite>
            <feBlend in="colored" in2="lit" mode="screen"></feBlend>
          </filter>

          <!-- Orb mask -->
          <mask id="orbMask">
            <rect width="100%" height="100%" fill="black"></rect>
            <circle cx="100" cy="100" r="62" fill="white"></circle>
          </mask>

          <!-- Fallback gradient -->
          <radialGradient id="orbGradient">
            <stop
              offset="0%"
              stop-color="rgb(var(--orb-ink))"
              stop-opacity="0.18"></stop>
            <stop
              offset="55%"
              stop-color="rgb(var(--orb-ink))"
              stop-opacity="0.38"></stop>
            <stop
              offset="100%"
              stop-color="rgb(var(--orb-ink))"
              stop-opacity="var(--orb-bg-opacity)"></stop>
          </radialGradient>
        </defs>

        <!-- ALWAYS render fallback -->
        <g filter="url(#orbFX)" mask="url(#orbMask)">
          {
            imageSrc && (
              <image
                href={imageSrc}
                x="38"
                y="38"
                width="124"
                height="124"
                preserveAspectRatio="xMidYMid slice"
                onerror="this.remove()"
              />
            )
          }

          <circle cx="100" cy="100" r="62" fill="url(#orbGradient)"></circle>
        </g>
      </svg>

      <div class="orb-lens">
        <svg
          viewBox="0 0 200 200"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <slot />
        </svg>
      </div>
    </div>

    <script>
      const root = document.documentElement;
      let lastScrollY = window.scrollY;
      let scrollBias = 0;

      function syncOrbTheme() {
        const isLight = root.classList.contains("light");
        document.querySelectorAll("[data-orb]").forEach((orb) => {
          orb.style.setProperty("--orb-energy", isLight ? "0.85" : "1");
        });
      }

      syncOrbTheme();
      new MutationObserver(syncOrbTheme).observe(root, {
        attributes: true,
        attributeFilter: ["class"],
      });

      window.addEventListener(
        "scroll",
        () => {
          const y = window.scrollY;
          const dy = y - lastScrollY;
          lastScrollY = y;

          scrollBias += Math.sign(dy) * 0.05;
          scrollBias *= 0.9;

          root.style.setProperty("--orb-scroll-bias", scrollBias.toFixed(4));
        },
        { passive: true },
      );

      const prefersReduced = matchMedia(
        "(prefers-reduced-motion: reduce)",
      ).matches;

      if (!prefersReduced) {
        window.addEventListener(
          "pointermove",
          (e) => {
            const vw = window.innerWidth;
            const vh = window.innerHeight;

            document.querySelectorAll("[data-orb]").forEach((orb) => {
              const r = orb.getBoundingClientRect();
              const cx = r.left + r.width / 2;
              const cy = r.top + r.height / 2;

              const dx = (e.clientX - cx) / vw;
              const dy = (e.clientY - cy) / vh;

              const dist = Math.hypot(dx, dy);
              const proximity = Math.max(0, 1 - dist * 3.2);

              orb.style.setProperty("--orb-proximity", proximity.toFixed(4));
            });
          },
          { passive: true },
        );
      }
    </script>

    <style>
      :root {
        --orb-ink: 255, 255, 255;
        --orb-glow: 255, 255, 255;
        --orb-bg-opacity: 0.55;
      }

      html.light {
        --orb-ink: 0, 0, 0;
        --orb-glow: 0, 0, 0;
        --orb-bg-opacity: 0.45;
      }

      /* Image-less or broken-image orbs are always white */
      .orb-card[data-has-image="false"] {
        --orb-ink: 255, 255, 255;
        --orb-glow: 255, 255, 255;
        --orb-bg-opacity: 0.55;
      }

      .orb-card {
        --orb-proximity: 0;
        --orb-scroll-bias: 0;
        --orb-mouse-x: 0;
        --orb-mouse-y: 0;

        /* per-orb micro variance */
        filter: hue-rotate(calc(attr(data-seed number) * 0.02deg));
      }

      .orb-card {
        width: 100%;
        height: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        pointer-events: none;
      }

      .orb-surface {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
      }

      .orb-wrap {
        position: absolute;
        inset: 0;
        pointer-events: none;
        filter: brightness(var(--orb-energy, 1));
      }

      .orb-wrap svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .orb-lens {
        position: absolute;
        inset: 18%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      .orb-wrap {
        filter: brightness(calc(0.96 + var(--orb-energy, 1) * 0.06))
          contrast(1.03) saturate(1.04);
      }

      @media (prefers-reduced-motion: reduce) {
        svg animate,
        feTurbulence animate {
          display: none;
        }
      }
    </style>
  </div>
</article>
