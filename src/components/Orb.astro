---
/*
Orb:
Plasma Orb - Petal
*/
import type { CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"petals">;
  type?: "text" | "audio" | "video" | "photo" | "project";
}

const { post } = Astro.props;

/* Extract first markdown image */
let imageSrc: string | null = null;

const match = post.body.match(/!\[.*?\]\((.*?)\)/);
if (match?.[1]) {
  const raw = match[1].trim();
  imageSrc =
    raw.startsWith("http") || raw.startsWith("/")
      ? raw
      : `/images/${raw.replace(/^\.?\//, "")}`;
}
---

<article class="orb-card" data-orb data-has-image={imageSrc ? "true" : "false"}>
  <div class="orb-surface">
    <div class="orb-wrap">
      <svg
        viewBox="0 0 200 200"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
      >
        <defs>
          <!-- Plasma filter -->
          <filter id="orbFX" x="0%" y="0%" width="100%" height="100%">
            <feTurbulence
              type="turbulence"
              baseFrequency="0.014"
              numOctaves="2"
              seed="4"
              result="noise"
            >
              <animate
                attributeName="baseFrequency"
                dur="7s"
                values="0.014;0.028;0.014"
                repeatCount="indefinite"></animate>
            </feTurbulence>

            <feDisplacementMap
              in="SourceGraphic"
              in2="noise"
              scale="40"
              result="warped"></feDisplacementMap>

            <feColorMatrix
              in="warped"
              type="matrix"
              values="
                1.04 0    0    0   -0.02
                0    1.04 0    0   -0.02
                0    0    1.04 0   -0.02
                0    0    0    1    0
              "
              result="colored"></feColorMatrix>

            <feSpecularLighting
              in="colored"
              surfaceScale="1"
              specularConstant="0.32"
              specularExponent="22"
              lighting-color="rgb(var(--orb-glow))"
              result="light"
            >
              <fePointLight x="100" y="100" z="140"></fePointLight>
            </feSpecularLighting>

            <feComposite in="light" in2="colored" operator="in" result="lit"
            ></feComposite>
            <feBlend in="colored" in2="lit" mode="screen"></feBlend>
          </filter>

          <!-- Orb mask -->
          <mask id="orbMask">
            <rect width="100%" height="100%" fill="black"></rect>
            <circle cx="100" cy="100" r="62" fill="white"></circle>
          </mask>

          <!-- Fallback gradient -->
          <radialGradient id="orbGradient">
            <stop
              offset="0%"
              stop-color="rgb(var(--orb-ink))"
              stop-opacity="0.18"></stop>
            <stop
              offset="55%"
              stop-color="rgb(var(--orb-ink))"
              stop-opacity="0.38"></stop>
            <stop
              offset="100%"
              stop-color="rgb(var(--orb-ink))"
              stop-opacity="var(--orb-bg-opacity)"></stop>
          </radialGradient>
        </defs>

        <!-- ALWAYS render fallback -->
        <g filter="url(#orbFX)" mask="url(#orbMask)">
          {
            imageSrc && (
              <image
                href={imageSrc}
                x="38"
                y="38"
                width="124"
                height="124"
                preserveAspectRatio="xMidYMid slice"
                onerror="this.remove()"
              />
            )
          }

          <circle cx="100" cy="100" r="62" fill="url(#orbGradient)"></circle>
        </g>
      </svg>

      <div class="orb-lens">
        <svg
          viewBox="0 0 200 200"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
        >
          <slot />
        </svg>
      </div>
    </div>

    <script>
      const root = document.documentElement;

      function syncOrbTheme() {
        const isLight = root.classList.contains("light");
        document.querySelectorAll("[data-orb]").forEach((orb) => {
          orb.style.setProperty("--orb-energy", isLight ? "0.85" : "1");
        });
      }

      syncOrbTheme();
      new MutationObserver(syncOrbTheme).observe(root, {
        attributes: true,
        attributeFilter: ["class"],
      });
    </script>

    <style>
      :root {
        --orb-ink: 255, 255, 255;
        --orb-glow: 255, 255, 255;
        --orb-bg-opacity: 0.55;
      }

      html.light {
        --orb-ink: 0, 0, 0;
        --orb-glow: 0, 0, 0;
        --orb-bg-opacity: 0.45;
      }

      /* Image-less or broken-image orbs are always white */
      .orb-card[data-has-image="false"] {
        --orb-ink: 255, 255, 255;
        --orb-glow: 255, 255, 255;
        --orb-bg-opacity: 0.55;
      }

      .orb-card {
        width: 100%;
        height: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        pointer-events: none;
      }

      .orb-surface {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
      }

      .orb-wrap {
        position: absolute;
        inset: 0;
        pointer-events: none;
        filter: brightness(var(--orb-energy, 1));
      }

      .orb-wrap svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      .orb-lens {
        position: absolute;
        inset: 18%;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }

      @media (prefers-reduced-motion: reduce) {
        svg animate,
        feTurbulence animate {
          display: none;
        }
      }
    </style>
  </div>
</article>
