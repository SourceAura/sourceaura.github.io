---
/*
PetalCard:
*/
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import FormattedDate from "./FormattedDate.astro";
import { readingTime } from "@lib/utils";

interface Props {
  post: CollectionEntry<"petals">;
  // Optional, future-proof, defaults to "text"
  type?: "text" | "audio" | "video" | "photo" | "project";
}

const { post, type = "text" } = Astro.props;
const { title, description, date } = post.data;

/* Extract first image (optional) */
let imageSrc: string | null = null;
const match = post.body.match(/!\[.*?\]\((.*?)\)/);
if (match?.[1]) {
  imageSrc = match[1].startsWith("http") ? match[1] : `/src/assets/${match[1]}`;
}
---

<article class="petal-card" data-petal data-type={type}>
  <a href={`/petals/${post.slug}/`} class="petal-link">
    <div class="petal-surface">
      <div class="petal-light"></div>

      {
        imageSrc && (
          <Image
            src={imageSrc}
            alt=""
            width={480}
            height={300}
            class="petal-media"
            loading="eager"
          />
        )
      }

      <div class="petal-content">
        <h2>{title}</h2>
        {description && <p>{description}</p>}
        <footer>
          <FormattedDate date={new Date(date)} />
          <span>•</span>
          <span>{readingTime(post.body)}</span>
        </footer>
      </div>
    </div>
  </a>
</article>

<script>
  // One-time controller for ALL PetalCards (batch pointer handling + shared heartbeat state)
  if (!window.__petalCardController) {
    window.__petalCardController = (() => {
      const state = {
        activeCard: null,
        beat: 0, // 0..1
        beatTimer: null,
        reduceMotion: matchMedia("(prefers-reduced-motion: reduce)").matches,
      };

      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

      const findCard = (node) =>
        node && node.closest ? node.closest("[data-petal]") : null;

      const getProximity = (card) => {
        // proximity is set on the carousel-item, not the card
        const item = card.closest(".carousel-item");
        const prox = item
          ? parseFloat(getComputedStyle(item).getPropertyValue("--petal-prox"))
          : 0;
        const depth = item
          ? parseFloat(getComputedStyle(item).getPropertyValue("--petal-depth"))
          : 1;
        return {
          prox: Number.isFinite(prox) ? prox : 0,
          depth: Number.isFinite(depth) ? depth : 1,
          isActive: item
            ? item.classList.contains("active")
            : card.classList.contains("active"),
        };
      };

      const setBeat = (v) => {
        state.beat = v;
        if (state.beatTimer) clearTimeout(state.beatTimer);
        state.beatTimer = setTimeout(() => (state.beat = 0), 140);
      };

      // External heartbeat hook (Qi can emit this)
      window.addEventListener("qi:beat", () => setBeat(1));

      // Pointer-driven lighting + tilt (batched)
      const onMove = (e) => {
        if (state.reduceMotion) return;

        const card = findCard(e.target);
        if (!card) return;

        state.activeCard = card;

        const surface = card.querySelector(".petal-surface");
        const light = card.querySelector(".petal-light");
        if (!surface || !light) return;

        const { prox, depth, isActive } = getProximity(card);

        const r = card.getBoundingClientRect();
        const x = e.clientX - r.left;
        const y = e.clientY - r.top;

        const intensity = (isActive ? 1 : 0.35) * (0.25 + prox * 0.75);
        const tiltMax = 6 * intensity;

        const rx = (y / r.height - 0.5) * -tiltMax;
        const ry = (x / r.width - 0.5) * tiltMax;

        // Press depth is stored on the card
        const press = parseFloat(card.dataset.press || "0") || 0;

        surface.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg) translateZ(${press}px)`;

        // Beat influences falloff, proximity influences base glow
        const glow = 0.1 + prox * 0.14 + state.beat * 0.1;

        light.style.background = `radial-gradient(circle at ${x}px ${y}px, rgba(255,255,255,${glow}), transparent 60%)`;

        // Blend with Quasar stars: send normalized position + strength
        const nx = clamp(x / r.width, 0, 1);
        const ny = clamp(y / r.height, 0, 1);
        const starInfluence = clamp(prox * 0.8 + (isActive ? 0.2 : 0), 0, 1);

        window.dispatchEvent(
          new CustomEvent("petal:light", {
            detail: {
              x: nx,
              y: ny,
              a: starInfluence,
              d: clamp(1 - depth, 0, 1),
            },
          }),
        );
      };

      const onLeave = (e) => {
        const card = findCard(e.target);
        if (!card) return;

        const surface = card.querySelector(".petal-surface");
        const light = card.querySelector(".petal-light");
        if (!surface || !light) return;

        const press = parseFloat(card.dataset.press || "0") || 0;
        surface.style.transform = `translateZ(${press}px)`;
        light.style.background = "";

        window.dispatchEvent(
          new CustomEvent("petal:light", {
            detail: { x: 0.5, y: 0.5, a: 0, d: 0 },
          }),
        );
      };

      // Press inward (optional)
      const onDown = (e) => {
        const card = findCard(e.target);
        if (!card) return;
        card.dataset.press = "-8";
      };

      const onUp = (e) => {
        const card = findCard(e.target);
        if (!card) return;
        card.dataset.press = "0";
      };

      // Audio micro-beats when active (quiet, randomized, no spam)
      const audioTimers = new WeakMap();

      const armAudioBeats = (card) => {
        if (card.dataset.type !== "audio") return;
        if (audioTimers.has(card)) return;

        const item = card.closest(".carousel-item");
        const mo = new MutationObserver(() => {
          const active = item
            ? item.classList.contains("active")
            : card.classList.contains("active");

          if (active) {
            if (audioTimers.get(card)?.interval) return;

            const tick = () => window.dispatchEvent(new CustomEvent("qi:beat"));
            tick();

            const interval = setInterval(
              () => {
                // Random jitter so it feels organic
                if (Math.random() < 0.55) tick();
              },
              1200 + Math.random() * 900,
            );

            audioTimers.set(card, { interval, mo });
          } else {
            const t = audioTimers.get(card);
            if (t?.interval) clearInterval(t.interval);
            audioTimers.set(card, { interval: null, mo });
          }
        });

        if (item) {
          mo.observe(item, { attributes: true, attributeFilter: ["class"] });
        } else {
          mo.observe(card, { attributes: true, attributeFilter: ["class"] });
        }

        audioTimers.set(card, { interval: null, mo });
      };

      const bootstrap = () => {
        document.querySelectorAll("[data-petal]").forEach(armAudioBeats);
      };

      // Use capture so we still get motion even if inner nodes vary
      document.addEventListener("pointermove", onMove, {
        passive: true,
        capture: true,
      });
      document.addEventListener("pointerleave", onLeave, {
        passive: true,
        capture: true,
      });
      document.addEventListener("pointerout", onLeave, {
        passive: true,
        capture: true,
      });

      document.addEventListener("pointerdown", onDown, {
        passive: true,
        capture: true,
      });
      document.addEventListener("pointerup", onUp, {
        passive: true,
        capture: true,
      });
      document.addEventListener("pointercancel", onUp, {
        passive: true,
        capture: true,
      });

      // Initial scan + re-scan when carousel swaps content (if ever)
      bootstrap();
      new MutationObserver(bootstrap).observe(document.body, {
        childList: true,
        subtree: true,
      });

      return { setBeat };
    })();
  }
</script>

<style>
  /* ─────────────────────────────
   CONTAINER
   ───────────────────────────── */
  .petal-card {
    height: 100%;
    perspective: 1200px;
    touch-action: manipulation;
    user-select: none;
  }

  .petal-link {
    display: block;
    height: 100%;
    text-decoration: none;
    color: inherit;
  }

  /* ─────────────────────────────
   SURFACE (depth-aware)
   ───────────────────────────── */
  .petal-surface {
    position: relative;
    height: 100%;
    border-radius: 18px;
    overflow: hidden;
    transform-style: preserve-3d;

    background: rgba(255, 255, 255, 0.03);
    backdrop-filter: blur(14px) saturate(120%);

    transition:
      transform 0.35s cubic-bezier(0.2, 0.6, 0.2, 1),
      box-shadow 0.35s cubic-bezier(0.2, 0.6, 0.2, 1),
      filter 0.4s ease;
  }

  /* Depth-aware shadow tuning:
   Uses --petal-depth from carousel-item (0 active -> 1 far) */
  .petal-card {
    --petal-depth: 1;
    --petal-prox: 0;
  }

  .carousel-item {
    height: 100%;
    pointer-events: none;

    /* ensures vars exist even before JS populates */
    --petal-depth: var(--petal-depth, 1);
    --petal-prox: var(--petal-prox, 0);
  }

  .petal-card .petal-surface {
    /* Pull depth vars from closest carousel-item */
    box-shadow: 0 calc(10px + (var(--petal-depth, 1) * 10px))
      calc(30px + (var(--petal-depth, 1) * 30px)) rgba(0, 0, 0, 0.35);
  }

  /* Active warmth shift (cinematic, subtle) */
  .carousel-item.active .petal-surface {
    filter: saturate(1.06) hue-rotate(-2deg);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
  }

  /* ─────────────────────────────
   LIGHT
   ───────────────────────────── */
  .petal-light {
    position: absolute;
    inset: 0;
    z-index: 1;
    pointer-events: none;
    transition: background 0.15s ease;
  }

  /* ─────────────────────────────
   MEDIA
   ───────────────────────────── */
  .petal-media {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    will-change: transform;
    backface-visibility: hidden;
    transform: translateZ(-20px) scale(1.05);
    filter: saturate(0.9) contrast(1.05);
  }
  .petal-surface {
    min-height: 100%;
  }

  /* ─────────────────────────────
   CONTENT
   ───────────────────────────── */
  .petal-content {
    position: relative;
    z-index: 2;
    height: 100%;
    padding: 16px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    gap: 6px;
    transform: translateZ(30px);
    color: white;
  }

  .petal-content h2 {
    font-size: 0.9rem;
    font-weight: 600;
    line-height: 1.25;
  }

  .petal-content p {
    font-size: 0.72rem;
    opacity: 0.8;
    line-height: 1.35;
  }

  .petal-content footer {
    font-size: 0.6rem;
    opacity: 0.55;
    display: flex;
    gap: 6px;
  }

  /* ─────────────────────────────
   REDUCED MOTION (still alive)
   ───────────────────────────── */
  @media (prefers-reduced-motion: reduce) {
    .petal-surface {
      transform: none !important;
      transition:
        box-shadow 0.35s ease,
        filter 0.35s ease;
    }
    .petal-light {
      display: none;
    }
  }
</style>
