---
/* Om - The Oscillator
 *
 * One global oscillator for:
 * - SysInfo ECG drift + shimmer
 * - PageFind pill glow + decay
 * - PageFind result breathing
 * - Quasar star brightness modulation
 */
---

<script is:inline>
  (() => {
    const root = document.documentElement;

    // If user prefers reduced motion, keep everything steady.
    const reduceMotion = window.matchMedia?.(
      "(prefers-reduced-motion: reduce)",
    );
    const isReduced = () => !!reduceMotion?.matches;

    // Guard: avoid double-mount on Astro client navigation.
    if (window.__pulse?.__mounted) return;

    let lastInteraction = performance.now();
    let baseHz = 0.9; // calm baseline
    let boostHz = 1.6; // "alert" / search-open
    let boosted = false;

    let phase = 0;
    let raf = 0;
    let running = false;

    // Utility: write CSS vars
    function writeVars(pulse, decay, ph) {
      root.style.setProperty("--pulse-phase", String(ph));
      root.style.setProperty("--pulse", String(pulse));
      root.style.setProperty("--pulse-decay", String(decay));
    }

    function touch() {
      lastInteraction = performance.now();
    }

    function setBoost(on) {
      boosted = !!on;
      touch();
    }

    function stop() {
      running = false;
      if (raf) cancelAnimationFrame(raf);
      raf = 0;
    }

    function start() {
      if (running) return;
      running = true;
      raf = requestAnimationFrame(loop);
    }

    function loop(t) {
      if (!running) return;

      // Background tab CPU saver
      if (document.hidden) {
        // Put vars into a calm, steady state while hidden
        writeVars("0.5", "0.0", phase);
        stop();
        return;
      }

      // Reduced motion: keep stable, no oscillation
      if (isReduced()) {
        writeVars("0.5", "0.0", phase);
        raf = requestAnimationFrame(loop); // still lightweight; could also stop entirely
        return;
      }

      const dt = Math.min((t - (loop.last || t)) / 1000, 0.05);
      loop.last = t;

      const idle = (t - lastInteraction) / 1000;
      const decay = Math.exp(-idle / 6); // glow decay curve

      const hz = boosted ? boostHz : baseHz;
      const speed = hz * (0.5 + decay * 0.8);

      phase += dt * speed * Math.PI * 2;

      const pulse = (Math.sin(phase) + 1) / 2;

      writeVars(pulse.toFixed(4), decay.toFixed(4), phase.toFixed(4));

      raf = requestAnimationFrame(loop);
    }

    // Resume on tab focus
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) start();
    });

    // React to reduced-motion changes
    reduceMotion?.addEventListener?.("change", () => {
      // If entering reduced mode, reset to calm
      if (isReduced()) writeVars("0.5", "0.0", phase.toFixed(4));
      touch();
    });

    // Public API
    window.__pulse = {
      __mounted: true,
      touch,
      setBoost,
    };

    // Initialize vars
    writeVars("0.5", "1.0", "0");
    start();
  })();
</script>
