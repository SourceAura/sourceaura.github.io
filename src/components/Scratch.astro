---
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import Giscus from "@components/Giscus.astro";
import { readingTime } from "@utils/utils";

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Static paths
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
export async function getStaticPaths() {
  const posts = (await getCollection("petals")).filter((p) => !p.data.draft);
  return posts.map((post) => ({ params: { slug: post.slug }, props: post }));
}

type Props = CollectionEntry<"petals">;
const post = Astro.props as Props;
const { Content } = await post.render();

const d = new Date(post.data.date);
const dateLabel = d.toLocaleDateString(undefined, {
  month: "2-digit",
  day: "2-digit",
  year: "numeric",
});
const rt = `${readingTime(post.body)} min`;

/* Extract first image */
let imageSrc: string | null = null;
const match = post.body.match(/!\[.*?\]\((.*?)\)/);
if (match?.[1]) {
  const raw = match[1].trim();
  imageSrc = raw.startsWith("http") ? raw : `/${raw.replace(/^\.?\//, "")}`;
}
---

<Layout title={post.data.title} description={post.data.excerpt ?? ""}>
  <Container>
    <section class="modr-scope">
      <!-- CARD -->
      <div class="container">
        <div class="card">
          <div class="content">
            <h3 class="title">{post.data.title}</h3>

            <div class="tags">
              <p>{dateLabel}</p>
              <span class="icon-time" aria-hidden="true">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <circle cx="12" cy="12" r="9"></circle>
                  <path d="M12 7v5l3 3"></path>
                </svg>
              </span>
              <p>{rt}</p>
            </div>

            <div class="text">
              {
                post.data.description && (
                  <p class="lede">{post.data.description}</p>
                )
              }
              <div class="article prose dark:prose-invert" data-pagefind-body>
                <Content />
              </div>
            </div>
          </div>

          <!-- STATS -->
          <div class="card-stats">
            <button class="stat" data-toggle-giscus title="Comments">
              ðŸ’¬ <span class="count" data-comments></span>
            </button>
          </div>

          <span class="icon-cue" aria-hidden="true">âŒƒ</span>
        </div>

        <figure>
          {
            imageSrc ? (
              <img src={imageSrc} alt="" />
            ) : (
              <div class="img-fallback" />
            )
          }
        </figure>
      </div>

      <!-- GISCUS -->
      <div id="giscus-wrapper" class="is-collapsed">
        <Giscus />
      </div>
    </section>
  </Container>
</Layout>

<script is:inline>
  /* Toggle Giscus */
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.querySelector("[data-toggle-giscus]");
    const giscus = document.getElementById("giscus-wrapper");
    if (!toggle || !giscus) return;

    toggle.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      giscus.classList.toggle("is-collapsed");
    });
  });

  /* Sync iframe theme with ThemeSwitch */
  const syncGiscusTheme = () => {
    const iframe = document.querySelector("iframe.giscus-frame");
    if (!iframe) return;

    iframe.contentWindow?.postMessage(
      {
        giscus: {
          setConfig: {
            theme: document.documentElement.classList.contains("dark")
              ? "transparent_dark"
              : "light",
          },
        },
      },
      "https://giscus.app",
    );
  };

  new MutationObserver(syncGiscusTheme).observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["class"],
  });
</script>

<style>
  /* Fixed centered card */
  .modr-scope {
    pointer-events: none;
  }

  .modr-scope > .container {
    position: fixed;
    left: 50%;
    top: 34%;
    transform: translate(-50%, -50%);
    width: min(980px, 100%);
    height: 420px;
    pointer-events: auto;
  }

  /* Giscus docked below card */
  #giscus-wrapper {
    position: fixed;
    left: 50%;
    top: calc(34% + 420px + 2.5rem);
    transform: translateX(-50%);
    width: min(980px, 100%);
    transition:
      opacity 200ms ease,
      transform 200ms ease,
      max-height 300ms ease;
    border-top: 1px solid color-mix(in oklch, currentColor 20%, transparent);
  }

  #giscus-wrapper.is-collapsed {
    opacity: 0;
    max-height: 0;
    transform: translateY(-6px);
    pointer-events: none;
    overflow: hidden;
  }
</style>
