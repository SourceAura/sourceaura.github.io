---
// src/components/SysInfo.astro
import Container from "@components/Container.astro";
// import NowPlaying from "@components/NowPlaying.astro";
---

<Container style="width: 210px; overflow: hidden; padding: 0 10px;">
  <button
    id="sys-info-btn"
    aria-label="System information"
    class="group relative flex w-full items-center justify-between overflow-hidden rounded-full border border-black/15 hover:bg-black/5 focus-visible:bg-black/5 dark:border-white/20 dark:hover:bg-white/5 dark:focus-visible:bg-white/5"
    style="background-size: cover; background-position: center; background-color: rgba(0, 0, 0, 0.5);"
  >
    <span
      id="current-time"
      class="text-ghost-600 cursor-pointer text-sm"
      style="white-space: nowrap; padding-left: 11px;"></span>

    <span
      id="track-info"
      class="text-ghost-600 marquee max-w-full cursor-pointer truncate text-sm"
      >Loadingâ€¦</span
    >

    <span
      id="online-indicator"
      class="glow-ring h-1 w-1 rounded-full"
      data-state="loading"
      title="Spotify status"
      style="padding-right: 11px;"></span>
  </button>

  <div
    id="now-playing-popover"
    class="absolute left-1/2 z-50 mt-2 hidden w-[310px] -translate-x-1/2 transform rounded bg-white shadow-lg"
  >
    <!-- Popover content -->
    <!-- <NowPlaying class="w-full" /> -->
  </div>

  <script type="module">
    const ENDPOINT = "/api/spotify/now-playing";
    const POLL_MS = 7000;

    let playbackState = "loading";
    let trackInfo = "Loadingâ€¦";
    let coverArt = "";

    function updateIndicatorState() {
      const indicator = document.getElementById("online-indicator");
      const trackInfoElement = document.getElementById("track-info");
      const sysInfoBtn = document.getElementById("sys-info-btn");

      if (!indicator || !trackInfoElement || !sysInfoBtn) return;

      switch (playbackState) {
        case "playing":
          indicator.className =
            "glow-ring h-1.5 w-1.5 rounded-full bg-green-600";
          indicator.setAttribute("title", "Spotify: Playing");
          indicator.style.boxShadow = "0 0 5px green, 0 0 10px lime";
          break;
        case "paused":
          indicator.className =
            "glow-ring h-1.5 w-1.5 rounded-full bg-yellow-600";
          indicator.setAttribute("title", "Spotify: Paused");
          indicator.style.boxShadow = "0 0 5px yellow, 0 0 10px orange";
          break;
        default:
          indicator.className = "glow-ring h-1.5 w-1.5 rounded-full bg-red-600";
          indicator.setAttribute("title", "Spotify: Not playing or offline");
          indicator.style.boxShadow = "0 0 5px red, 0 0 10px crimson";
          break;
      }

      trackInfoElement.textContent = trackInfo;
      sysInfoBtn.style.backgroundImage = coverArt ? `url(${coverArt})` : "";
    }

    function updateCurrentTime() {
      const timeElement = document.getElementById("current-time");
      if (!timeElement) return;

      const now = new Date();
      timeElement.textContent = now.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // time
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // popover toggle
    document
      .getElementById("track-info")
      ?.addEventListener("click", (event) => {
        event.stopPropagation();
        const pop = document.getElementById("now-playing-popover");
        if (!pop) return;

        pop.classList.toggle("hidden");
        const rect = event.target.getBoundingClientRect();
        pop.style.top = `${rect.bottom}px`;
        pop.style.left = `${rect.left}px`;
      });

    document.getElementById("sys-info-btn")?.addEventListener("click", () => {
      window.location.href = "/euthymia";
    });

    async function poll() {
      try {
        const res = await fetch(ENDPOINT, { cache: "no-store" });
        if (!res.ok) throw new Error("API not ok");

        const data = await res.json();

        if (data?.isPlaying) {
          playbackState = "playing";
        } else if (data?.title) {
          playbackState = "paused";
        } else {
          playbackState = "not_playing";
        }

        trackInfo = data?.title
          ? `${data.title} - ${data.artist || ""}`.trim()
          : "ðŸ˜´ afk ðŸ’¤";
        coverArt = data?.albumImageUrl || "";

        updateIndicatorState();
      } catch (e) {
        playbackState = "offline";
        trackInfo = "Spotify offline";
        coverArt = "";
        updateIndicatorState();
      }
    }

    // start polling
    poll();
    setInterval(poll, POLL_MS);
  </script>

  <style>
    .glow-ring {
      position: relative;
      border: 1px solid transparent;
      border-radius: 50%;
      animation: pulsate 2s infinite;
      margin-left: 8px;
    }

    @keyframes pulsate {
      0% {
        transform: scale(0.9);
        box-shadow: 0 0 0 0px rgba(255, 255, 255, 0.7);
      }
      50% {
        transform: scale(1);
        box-shadow: 0 0 0 5px rgba(255, 255, 255, 0);
      }
      100% {
        transform: scale(0.9);
        box-shadow: 0 0 0 0px rgba(255, 255, 255, 0);
      }
    }

    #track-info {
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      width: 100%;
      animation: marquee 10s linear infinite;
    }

    @keyframes marquee {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }
  </style>
</Container>
