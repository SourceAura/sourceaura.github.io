---
import Container from "@components/Container.astro";
---

<Container style="width: 260px; overflow: hidden; padding: 0 10px;">
  <a
    href="/euthymia"
    aria-label="System information"
    class="group relative flex w-full items-center overflow-hidden rounded-full border border-black/15 hover:bg-black/5 focus-visible:bg-black/5 dark:border-white/20 dark:hover:bg-white/5 dark:focus-visible:bg-white/5"
    style="background-color: transparent; text-decoration: none;"
  >
    <!-- ECG BACKGROUND -->
    <canvas
      id="heartbeat"
      width="180"
      height="18"
      class="pointer-events-none absolute inset-0 m-auto"
      style="z-index: 0;"></canvas>

    <!-- FOREGROUND CONTENT -->
    <div class="relative z-10 flex w-full items-center px-3">
      <!-- Time (left) -->
      <span
        data-role="sysinfo-time"
        class="text-ghost-600 cursor-pointer text-sm"
        style="white-space: nowrap;"></span>

      <!-- INVISIBLE SPACER (â‰ˆ 2/3 width) -->
      <span aria-hidden="true" class="block" style="width: 80px;"></span>

      <!-- Indicator (right) -->
      <span
        class="glow-ring ml-auto h-1.5 w-1.5 rounded-full"
        title="System vitals"></span>
    </div>
  </a>

  <script type="module">
    /* =========================
       Time (Military, multi-mount safe)
    ========================= */
    function updateCurrentTime() {
      const timeEl = document.querySelector('[data-role="sysinfo-time"]');
      if (!timeEl) return;

      const now = new Date();
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      const value = `${hours}:${minutes}`;

      if (timeEl.textContent !== value) {
        timeEl.textContent = value;
      }
    }

    if (window.__sysinfoTimeInterval) {
      clearInterval(window.__sysinfoTimeInterval);
    }

    updateCurrentTime();
    window.__sysinfoTimeInterval = setInterval(updateCurrentTime, 1000);

    /* =========================
       ECG Simulation Engine
    ========================= */
    const canvas = document.getElementById("heartbeat");
    const ctx = canvas.getContext("2d");

    const W = canvas.width;
    const H = canvas.height;
    const MID = H / 2;

    let x = 0;
    let lastTime = performance.now();
    let nextBeatAt = 0;
    let baselinePhase = 0;
    let visible = true;

    let heartRate = 58 + Math.random() * 6;
    let beat = null;

    const TRAIL_ALPHA_VISIBLE = 0.06;
    const TRAIL_ALPHA_HIDDEN = 0.085;

    document.addEventListener("visibilitychange", () => {
      visible = !document.hidden;
    });

    function setThemeColor() {
      const isDark = document.documentElement.classList.contains("dark");
      const color = isDark ? "255,255,255" : "20,20,20";

      ctx.lineWidth = 1;
      ctx.strokeStyle = `rgba(${color},0.9)`;
      ctx.shadowColor = `rgba(${color},0.55)`;
      ctx.shadowBlur = 5;
    }

    setThemeColor();
    new MutationObserver(setThemeColor).observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"],
    });

    function scheduleBeat(type = "normal") {
      let interval;

      if (type === "premature") interval = 420 + Math.random() * 240;
      else if (type === "pause") interval = 1800 + Math.random() * 700;
      else {
        interval = 60000 / heartRate;
        interval *= 0.94 + Math.random() * 0.12;
      }

      nextBeatAt = performance.now() + interval;

      const rBase = 10 + Math.random() * 4;
      const isPAC = type === "premature";

      beat = {
        age: 0,
        duration: (isPAC ? 120 : 145) + Math.random() * 55,
        q: -(1.8 + Math.random() * 1.2),
        r: rBase * (isPAC ? 0.85 : 1.0),
        s: -(4 + Math.random() * 2.5),
        t: (2 + Math.random() * 1.8) * (isPAC ? 0.75 : 1.0),
      };
    }

    scheduleBeat("normal");

    function beatValue(b) {
      const p = b.age / b.duration;
      if (p < 0.08) return 0;
      if (p < 0.11) return b.q * ((p - 0.08) / 0.03);
      if (p < 0.135) return b.r;
      if (p < 0.19) return b.s;
      if (p < 0.48) return b.t * Math.sin((p - 0.19) * Math.PI * 2.1);
      return 0;
    }

    function fade(alpha) {
      ctx.save();
      ctx.globalCompositeOperation = "destination-out";
      ctx.fillStyle = `rgba(0,0,0,${alpha})`;
      ctx.fillRect(0, 0, W, H);
      ctx.restore();
    }

    function frame(now) {
      const dt = now - lastTime;
      lastTime = now;

      fade(visible ? TRAIL_ALPHA_VISIBLE : TRAIL_ALPHA_HIDDEN);
      ctx.beginPath();

      const steps = visible ? 2 : 1;

      for (let i = 0; i < steps; i++) {
        baselinePhase += 0.0022;
        const wander = Math.sin(baselinePhase) * 0.65;
        const noise = (Math.random() - 0.5) * 0.22;

        let y = MID + wander + noise;

        if (beat) {
          y -= beatValue(beat);
          beat.age += 1;
          if (beat.age > beat.duration + 12) beat = null;
        }

        ctx.moveTo(x, y);
        ctx.lineTo(x + 1, y);

        x += 1;
        if (x >= W) x = 0;
      }

      ctx.stroke();

      if (visible && now >= nextBeatAt) {
        const roll = Math.random();
        if (roll < 0.04) scheduleBeat("premature");
        else if (roll < 0.06) scheduleBeat("pause");
        else scheduleBeat("normal");
      } else if (!visible && now >= nextBeatAt) {
        scheduleBeat("normal");
      }

      heartRate += (Math.random() - 0.5) * 0.0025 * (dt / 16.67);
      heartRate = Math.min(68, Math.max(52, heartRate));

      requestAnimationFrame(frame);
    }

    requestAnimationFrame(frame);
  </script>

  <style>
    .glow-ring {
      animation: pulse 3s infinite;
      background-color: currentColor;
      box-shadow: 0 0 6px currentColor;
    }

    .dark .glow-ring {
      color: white;
    }

    :root:not(.dark) .glow-ring {
      color: #111;
    }

    @keyframes pulse {
      0% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
      100% {
        opacity: 0.6;
      }
    }

    #heartbeat {
      background: transparent;
      image-rendering: pixelated;
    }

    @media (max-width: 768px) {
      .sysinfo-root {
        position: absolute;
        top: env(safe-area-inset-top);
      }
    }
  </style>
</Container>
