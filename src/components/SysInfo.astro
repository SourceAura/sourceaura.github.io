---
import Container from "@components/Container.astro";
---

<Container style="width: 260px; overflow: hidden; padding: 0 10px;">
  <a
    href="/euthymia"
    aria-label="System information"
    class="group relative flex w-full items-center overflow-hidden rounded-full border border-black/15 hover:bg-black/5 focus-visible:bg-black/5 dark:border-white/20 dark:hover:bg-white/5 dark:focus-visible:bg-white/5"
    style="background-color: transparent; text-decoration: none;"
  >
    <canvas
      id="heartbeat"
      width="180"
      height="18"
      class="pointer-events-none absolute inset-0 m-auto"
      style="z-index: 0;"></canvas>

    <div class="relative z-10 flex w-full items-center px-3">
      <span
        data-role="sysinfo-time"
        class="text-ghost-600 cursor-pointer text-sm"
        style="white-space: nowrap;"></span>

      <span aria-hidden="true" class="block" style="width: 80px;"></span>

      <span
        class="glow-ring ml-auto h-1.5 w-1.5 rounded-full"
        title="System vitals"></span>
    </div>
  </a>

  <script type="module">
    /* ===============================
       TIME + TEMPORAL FLARES
    =============================== */
    let flare = 0;
    let lastSecond = null;

    function updateCurrentTime() {
      const el = document.querySelector("[data-role='sysinfo-time']");
      if (!el) return;

      const d = new Date();
      const h = String(d.getHours()).padStart(2, "0");
      const m = String(d.getMinutes()).padStart(2, "0");
      const s = d.getSeconds();

      el.textContent = `${h}:${m}`;

      if (s !== lastSecond) {
        lastSecond = s;

        if (s === 0) flare = 1.2;
        else if (s === 15) flare = 0.7;
        else if (s === 30) flare = 0.9;
        else if (s === 45) flare = 0.6;
      }
    }

    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    /* ===============================
       CANVAS SETUP
    =============================== */
    const canvas = document.getElementById("heartbeat");
    const ctx = canvas.getContext("2d");

    const W = canvas.width;
    const H = canvas.height;
    const MID = H / 2;

    const reduceMotion = matchMedia("(prefers-reduced-motion: reduce)").matches;

    let x = 0;
    let t = 0;

    /* ===============================
       PAGEFIND COMPRESSION
    =============================== */
    let compression = 1;

    window.addEventListener("open-pagefind", () => {
      compression = 0.6;
    });
    window.addEventListener("close-pagefind", () => {
      compression = 1;
    });

    /* ===============================
       COLOR + QI PHASE
    =============================== */
    function getRGB() {
      return document.documentElement.classList.contains("dark")
        ? "255,255,255"
        : "20,20,20";
    }

    function getQiPhase() {
      const styles = getComputedStyle(document.documentElement);
      return parseFloat(styles.getPropertyValue("--pulse-phase")) || 0;
    }

    /* ===============================
       PARTICLES
    =============================== */
    const particles = Array.from({ length: 28 }, () => ({
      x: Math.random() * W,
      y: MID,
      v: 0.4 + Math.random() * 0.6,
      life: Math.random(),
      glyphLock: 0,
    }));

    function drawParticles(rgb, waveY, phase) {
      for (const p of particles) {
        p.x -= p.v;
        p.life -= 0.008;

        if (p.x < 0 || p.life <= 0) {
          p.x = W + Math.random() * 40;
          p.life = 1;
          p.glyphLock = 0;
        }

        // Qi-biased attraction
        const phaseBias = Math.sin(phase * Math.PI * 2) * 2;
        const targetY = waveY + phaseBias;
        p.y += (targetY - p.y) * 0.08;

        // Glyph constellation lock during strong flares
        if (flare > 0.9 && p.glyphLock === 0) {
          p.glyphLock = Math.random() < 0.4 ? 1 : 0;
        }

        if (p.glyphLock) {
          p.y += Math.sign(MID - p.y) * 0.6;
          p.x += Math.sin(t * 2) * 0.2;
        }

        ctx.globalAlpha = p.life * 0.7;
        ctx.fillStyle = `rgba(${rgb},0.85)`;
        ctx.fillRect(p.x, p.y, 1, 1);
      }

      ctx.globalAlpha = 1;
    }

    /* ===============================
       FRAME LOOP
    =============================== */
    function frame() {
      const rgb = getRGB();
      const phase = getQiPhase();

      ctx.globalCompositeOperation = "destination-out";
      ctx.fillStyle = "rgba(0,0,0,0.08)";
      ctx.fillRect(0, 0, W, H);
      ctx.globalCompositeOperation = "source-over";

      ctx.strokeStyle = `rgba(${rgb},0.9)`;
      ctx.lineWidth = 1;
      ctx.shadowColor = `rgba(${rgb},0.55)`;
      ctx.shadowBlur = 6 + flare * 6;

      ctx.beginPath();

      let lastWaveY = MID;

      for (let i = 0; i < 2; i++) {
        const nx = x / W;

        let wave =
          Math.sin(nx * Math.PI * 4 + t) * 3 +
          Math.sin(nx * Math.PI * 12 - t * 1.3) * 1.2;

        if (flare > 0) {
          wave += Math.sin(nx * Math.PI * 24 + t * 2) * flare * 2;
        }

        wave *= compression;
        const y = MID + wave;
        lastWaveY = y;

        ctx.moveTo(x, y);
        ctx.lineTo(x + 1, y);

        x += 1;
        if (x >= W) x = 0;
      }

      ctx.stroke();
      ctx.shadowBlur = 0;

      drawParticles(rgb, lastWaveY, phase);

      flare *= 0.9;
      compression += (1 - compression) * 0.05;

      t += 0.04;
      requestAnimationFrame(frame);
    }

    function drawStatic() {
      ctx.clearRect(0, 0, W, H);
      ctx.beginPath();
      ctx.moveTo(0, MID);
      ctx.lineTo(W, MID);
      ctx.strokeStyle = `rgba(${getRGB()},0.6)`;
      ctx.stroke();
    }

    if (reduceMotion) drawStatic();
    else frame();
  </script>

  <style>
    .glow-ring {
      animation: pulse 3s infinite;
      background-color: currentColor;
      box-shadow: 0 0 6px currentColor;
    }

    .dark .glow-ring {
      color: white;
    }

    :root:not(.dark) .glow-ring {
      color: #111;
    }

    @keyframes pulse {
      0% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
      100% {
        opacity: 0.6;
      }
    }

    #heartbeat {
      background: transparent;
    }
  </style>
</Container>
