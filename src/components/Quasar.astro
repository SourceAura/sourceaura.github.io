<quasar-background></quasar-background>

<style>
  quasar-background {
    position: fixed;
    inset: 0;
    z-index: -1;
    pointer-events: none;
    contain: strict;
  }

  canvas {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    display: block;
  }
</style>

<script>
  const COUNT = 220;
  const SPEED = 0.05;
  const MAX_DT = 2;

  function getViewport() {
    if (window.visualViewport) {
      return {
        width: window.visualViewport.width,
        height: window.visualViewport.height,
        scale: window.visualViewport.scale || 1,
      };
    }
    return {
      width: window.innerWidth,
      height: window.innerHeight,
      scale: 1,
    };
  }

  class Star {
    constructor(x, y) {
      this.x = x;
      this.y = y;
      this.z = Math.random();
      this.xPrev = x;
      this.yPrev = y;
    }

    update(w, h, speed, dt) {
      this.xPrev = this.x;
      this.yPrev = this.y;

      this.z += speed * 0.07 * dt;
      this.x += this.x * speed * 0.025 * this.z * dt;
      this.y += this.y * speed * 0.025 * this.z * dt;

      if (
        this.x < -w / 2 ||
        this.x > w / 2 ||
        this.y < -h / 2 ||
        this.y > h / 2
      ) {
        this.x = Math.random() * w - w / 2;
        this.y = Math.random() * h - h / 2;
        this.z = 0;
        this.xPrev = this.x;
        this.yPrev = this.y;
      }
    }

    draw(ctx, light) {
      const alpha = Math.min(this.z, 1);
      ctx.strokeStyle = light
        ? `rgba(0,0,0,${alpha})`
        : `rgba(255,255,255,${alpha})`;
      ctx.lineWidth = Math.min(this.z * 0.6, 2);
      ctx.beginPath();
      ctx.moveTo(this.x, this.y);
      ctx.lineTo(this.xPrev, this.yPrev);
      ctx.stroke();
    }
  }

  class QuasarBackground extends HTMLElement {
    constructor() {
      super();
      this.canvas = document.createElement("canvas");
      this.ctx = this.canvas.getContext("2d", { alpha: true });
      this.stars = [];
      this.lastTime = 0;
      this.raf = 0;
      this.isLight = false;
    }

    connectedCallback() {
      this.appendChild(this.canvas);
      this.resize();

      window.addEventListener("resize", this.resize);
      window.visualViewport?.addEventListener("resize", this.resize);
      window.visualViewport?.addEventListener("scroll", this.resize);
      window.addEventListener("orientationchange", this.resize);

      this.watchTheme();

      this.lastTime = performance.now();
      this.raf = requestAnimationFrame(this.frame);
    }

    disconnectedCallback() {
      cancelAnimationFrame(this.raf);
      window.removeEventListener("resize", this.resize);
      window.visualViewport?.removeEventListener("resize", this.resize);
      window.visualViewport?.removeEventListener("scroll", this.resize);
      window.removeEventListener("orientationchange", this.resize);
    }

    resize = () => {
      const { width, height } = getViewport();
      const dpr = Math.min(window.devicePixelRatio || 1, 2);

      this.canvas.width = Math.ceil(width * dpr);
      this.canvas.height = Math.ceil(height * dpr);
      this.canvas.style.width = `${width}px`;
      this.canvas.style.height = `${height}px`;

      this.ctx.setTransform(dpr, 0, 0, dpr, width / 2, height / 2);

      this.stars = Array.from(
        { length: COUNT },
        () =>
          new Star(
            Math.random() * width - width / 2,
            Math.random() * height - height / 2,
          ),
      );
    };

    watchTheme() {
      const update = () => {
        this.isLight = document.documentElement.classList.contains("light");
        this.ctx.fillStyle = this.isLight
          ? "rgba(255,255,255,0.15)"
          : "rgba(0,0,0,0.15)";
      };
      update();
      new MutationObserver(update).observe(document.documentElement, {
        attributes: true,
        attributeFilter: ["class"],
      });
    }

    frame = (t) => {
      let dt = (t - this.lastTime) / 16.67;
      this.lastTime = t;
      dt = Math.min(dt, MAX_DT);

      const { width, height } = getViewport();

      this.ctx.fillRect(-width / 2, -height / 2, width, height);

      for (const s of this.stars) {
        s.update(width, height, SPEED, dt);
        s.draw(this.ctx, this.isLight);
      }

      this.raf = requestAnimationFrame(this.frame);
    };
  }

  customElements.define("quasar-background", QuasarBackground);
</script>
