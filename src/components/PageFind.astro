---
import Search from "astro-pagefind/components/Search";
---

<div
  id="backdrop"
  class="pointer-events-none invisible fixed inset-0 z-40 bg-transparent"
>
  <div id="pagefind-shell" class="flex justify-center">
    <div
      id="pagefind-container"
      class="relative flex max-h-[70vh] w-full max-w-screen-sm flex-col overflow-auto rounded border bg-transparent p-4 shadow-xl"
    >
      <Search
        client:only="preact"
        id="search"
        className="pagefind-ui"
        uiOptions={{
          showImages: true,
          excerptLength: 16,
          resetStyles: false,
          filters: { nav: true },
        }}
      />

      <div class="mt-2 flex items-baseline justify-between text-xs">
        <span id="current-time" class="font-mono tabular-nums"></span>
        <span>Press <kbd>Esc</kbd></span>
      </div>
    </div>
  </div>
</div>

<style is:global>
  .pagefind-ui,
  .pagefind-ui * {
    color: var(--ui-text);
  }
  .pagefind-ui__result-excerpt,
  .pagefind-ui__result-meta {
    color: var(--ui-muted) !important;
  }
  #search input {
    background: transparent;
    color: var(--ui-text);
    caret-color: var(--ui-text);
    outline: none !important;
    animation: caret-pulse 2.4s infinite linear;
  }
  @keyframes caret-pulse {
    0% {
      caret-color: color-mix(in oklch, var(--ui-text) 55%, transparent);
    }
    50% {
      caret-color: color-mix(
        in oklch,
        var(--ui-text) calc(55% + 45% * var(--pulse)),
        transparent
      );
    }
    100% {
      caret-color: color-mix(in oklch, var(--ui-text) 55%, transparent);
    }
  }
</style>

<script>
  const backdrop = document.getElementById("backdrop");
  const shell = document.getElementById("pagefind-shell");
  const container = document.getElementById("pagefind-container");
  const root = document.documentElement;

  let isOpen = false;
  let scrollMemory = 0;
  let inactivityTimer = null;

  let y = -14;
  let v = 0;
  let target = -14;
  let rafSpring = 0;
  let lastT = 0;

  const STIFFNESS = 520;
  const DAMPING = 38;
  const MASS = 1;

  function setProximity() {
    const p = Math.max(0, Math.min(1, 1 - Math.abs(y) / 14));
    root.style.setProperty("--search-proximity", p.toFixed(4));
    root.style.setProperty("--search-lift", (p * 1.2).toFixed(4));
  }

  function applySpringStyles() {
    const p = Math.max(0, Math.min(1, 1 - Math.abs(y) / 14));
    shell.style.transform = `translateY(${y}px) scale(${0.985 + 0.015 * p})`;
    shell.style.opacity = String(0.1 + 0.9 * p);
    setProximity();
  }

  function startSpring() {
    if (rafSpring) return;
    lastT = performance.now();
    rafSpring = requestAnimationFrame(tickSpring);
  }

  function tickSpring(t) {
    const dt = Math.min((t - lastT) / 1000, 0.033);
    lastT = t;

    if (document.hidden) return;

    const F = -STIFFNESS * (y - target) - DAMPING * v;
    const a = F / MASS;

    v += a * dt;
    y += v * dt;

    if (Math.abs(v) < 0.02 && Math.abs(y - target) < 0.05) {
      y = target;
      v = 0;
      applySpringStyles();
      rafSpring = 0;
      return;
    }

    applySpringStyles();
    rafSpring = requestAnimationFrame(tickSpring);
  }

  function openPagefind() {
    window.__pulse?.touch?.();
    isOpen = true;
    backdrop.classList.remove("invisible", "pointer-events-none");
    root.classList.add("pagefind-open");
    target = 0;
    startSpring();
  }

  function closePagefind() {
    isOpen = false;
    scrollMemory = container.scrollTop;
    target = -14;
    startSpring();
    backdrop.classList.add("invisible", "pointer-events-none");
    root.classList.remove("pagefind-open");
  }

  window.togglePagefind = () => (isOpen ? closePagefind() : openPagefind());

  /* CLOCK â€” SAFE, INLINE, NO IDENTIFIERS */
  function updateTime() {
    const el = document.getElementById("current-time");
    if (!el) return;

    el.textContent = new Intl.DateTimeFormat(
      navigator.languages || [navigator.language],
      {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      },
    ).format(new Date());
  }

  updateTime();
  setInterval(updateTime, 1000);
</script>
