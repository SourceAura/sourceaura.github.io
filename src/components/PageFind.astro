---
/*
PageFind: displays a search section.
*/
import Search from "astro-pagefind/components/Search";
---

<div
  id="backdrop"
  class="pointer-events-none invisible fixed inset-0 z-40 bg-transparent"
>
  <div id="pagefind-shell" class="flex justify-center">
    <div
      id="pagefind-container"
      class="relative flex max-h-[70vh]
        w-full
        max-w-screen-sm flex-col overflow-auto
        bg-transparent p-4"
    >
      <Search
        id="search"
        className="pagefind-ui"
        options={{
          showImages: true,
          excerptLength: 16,
          resetStyles: false,
        }}
      />

      <div class="mt-2 flex items-baseline justify-between text-xs"></div>
    </div>
  </div>
</div>

<script>
  const backdrop = document.getElementById("backdrop");
  const shell = document.getElementById("pagefind-shell");
  const container = document.getElementById("pagefind-container");
  const root = document.documentElement;

  let isOpen = false;
  let scrollMemory = 0;

  let y = -14;
  let v = 0;
  let target = -14;
  let rafSpring = 0;
  let lastT = 0;

  const STIFFNESS = 520;
  const DAMPING = 38;
  const MASS = 1;

  /* ---------------------------
     INPUT MODALITY TRACKING
     --------------------------- */
  let keyboardFocus = false;

  window.addEventListener("keydown", () => {
    keyboardFocus = true;
    root.classList.add("keyboard-focus");
    root.classList.remove("mouse-focus");
  });

  window.addEventListener("pointerdown", () => {
    keyboardFocus = false;
    root.classList.add("mouse-focus");
    root.classList.remove("keyboard-focus");
  });

  function applySpringStyles() {
    const p = Math.max(0, Math.min(1, 1 - Math.abs(y) / 14));
    shell.style.transform = `translateY(${y}px) scale(${0.985 + 0.015 * p})`;
    shell.style.opacity = String(0.1 + 0.9 * p);

    // Qi drives glow intensity
    root.style.setProperty("--qi", p.toFixed(4));
  }

  function startSpring() {
    if (rafSpring) return;
    lastT = performance.now();
    rafSpring = requestAnimationFrame(tickSpring);
  }

  function stopSpring() {
    if (!rafSpring) return;
    cancelAnimationFrame(rafSpring);
    rafSpring = 0;
  }

  function tickSpring(t) {
    const dt = Math.min((t - lastT) / 1000, 0.033);
    lastT = t;

    const F = -STIFFNESS * (y - target) - DAMPING * v;
    v += (F / MASS) * dt;
    y += v * dt;

    if (Math.abs(v) < 0.02 && Math.abs(y - target) < 0.05) {
      y = target;
      v = 0;
      applySpringStyles();
      stopSpring();
      return;
    }

    applySpringStyles();
    rafSpring = requestAnimationFrame(tickSpring);
  }

  function openPagefind() {
    isOpen = true;
    backdrop.classList.remove("invisible", "pointer-events-none");
    backdrop.classList.add("visible");
    target = 0;
    startSpring();

    requestAnimationFrame(() => {
      container.scrollTop = scrollMemory;
      document.querySelector("#search input")?.focus({ preventScroll: true });
    });
  }

  function closePagefind() {
    isOpen = false;
    scrollMemory = container.scrollTop;
    target = -14;
    startSpring();
    backdrop.classList.add("invisible", "pointer-events-none");
    backdrop.classList.remove("visible");
    const input = document.querySelector("#search input");
    if (input) input.value = "";
  }

  window.togglePagefind = () => (isOpen ? closePagefind() : openPagefind());

  document.addEventListener("keydown", (e) => {
    if (e.key === "/" || ((e.metaKey || e.ctrlKey) && e.key === "k")) {
      e.preventDefault();
      window.togglePagefind();
    }
    if (e.key === "Escape") closePagefind();
  });

  backdrop.addEventListener("click", (e) => {
    if (!e.target.closest("#pagefind-container")) closePagefind();
  });

  shell.style.marginTop = "calc(var(--header-height, 72px) + 12px)";
  applySpringStyles();

  /* =====================================================
     PAGEFIND — THUMBNAIL CLICK NAVIGATION
  ===================================================== */

  document.addEventListener("click", (e) => {
    const thumb = e.target.closest(".pagefind-ui__result-thumb");
    if (!thumb) return;

    const result = thumb.closest(".pagefind-ui__result");
    if (!result) return;

    const link = result.querySelector(".pagefind-ui__result-title a");
    if (!link) return;

    // Respect new tab / modifier clicks
    if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) {
      window.open(link.href, "_blank");
      return;
    }

    window.location.href = link.href;
  });
</script>

<style is:global>
  /* =====================================================
     THEME + GLOW VARS
  ===================================================== */

  :root {
    --qi: 0;
    --search-glow: oklch(0.72 0.06 255);
  }

  html.dark {
    --search-glow: oklch(0.95 0.01 255);
  }

  /* Force white text in dark mode */
  html.dark .pagefind-ui,
  html.dark .pagefind-ui * {
    color: #ffffff !important;
  }

  html.light .pagefind-ui,
  html.light .pagefind-ui * {
    color: #000000 !important;
  }

  /* =====================================================
     SEARCH INPUT BORDER — THEME LOCK
  ===================================================== */

  /* Light mode: black border */
  html.light .pagefind-ui__search-input input {
    border-color: #000000 !important;
  }

  /* Dark mode: white border */
  html.dark .pagefind-ui__search-input input {
    border-color: #ffffff !important;
  }

  /* =====================================================
     SEARCH INPUT — TRANSPARENT + INTENTIONAL GLOW
  ===================================================== */

  .pagefind-ui__search-input {
    border-radius: 999px;
    overflow: hidden;
    background: transparent !important;
  }

  .pagefind-ui__search-input input {
    width: 100%;
    padding: 0.75rem 1.25rem;
    border-radius: 999px !important;

    background: transparent !important;
    border: 1px solid currentColor;

    color: inherit;
    caret-color: currentColor;

    outline: none !important;
    box-shadow: none !important;
  }

  /* Kill Pagefind + browser focus ring */
  .pagefind-ui__search-input:focus-within {
    outline: none !important;
    box-shadow: none !important;
  }
  /* =====================================================
     SCROLLBAR — SLIM / LOW VISUAL WEIGHT
  ===================================================== */

  /* Firefox */
  #pagefind-container {
    scrollbar-width: thin; /* already thin, keep */
  }

  /* WebKit (Chrome, Safari, Edge) */
  #pagefind-container::-webkit-scrollbar {
    width: 5px; /* ↓ from 8px */
    height: 5px;
  }

  #pagefind-container::-webkit-scrollbar-thumb {
    border-radius: 999px;
    opacity: 0.65; /* slightly lighter presence */
  }

  /* =====================================================
     SCROLLBAR — ULTRA SLIM (≈ 50%)
  ===================================================== */

  /* Firefox */
  #pagefind-container {
    scrollbar-width: thin; /* Firefox only supports auto | thin */
  }

  /* WebKit browsers (Chrome, Safari, Edge) */
  #pagefind-container::-webkit-scrollbar {
    width: 4px; /* ↓ half of original 8px */
    height: 4px;
  }

  #pagefind-container::-webkit-scrollbar-thumb {
    border-radius: 999px;
    opacity: 0.6;
  }

  /* Optional: slightly stronger on hover so it’s still usable */
  #pagefind-container::-webkit-scrollbar-thumb:hover {
    opacity: 0.9;
  }

  /* =====================================================
     SCROLLBAR — HIDDEN UNTIL SCROLL
  ===================================================== */

  /* Firefox */
  #pagefind-container {
    scrollbar-width: none; /* hidden by default */
  }

  /* Show scrollbar in Firefox while hovering / scrolling */
  #pagefind-container:hover {
    scrollbar-width: thin;
  }

  /* WebKit browsers (Chrome, Safari, Edge) */
  #pagefind-container::-webkit-scrollbar {
    width: 0px;
    height: 0px;
  }

  /* Reveal scrollbar on interaction */
  #pagefind-container:hover::-webkit-scrollbar,
  #pagefind-container:active::-webkit-scrollbar {
    width: 4px;
    height: 4px;
  }

  /* Thumb styling (inherits theme color) */
  #pagefind-container::-webkit-scrollbar-thumb {
    background-color: currentColor;
    border-radius: 999px;
    opacity: 0;
    transition: opacity 160ms ease;
  }

  /* Fade thumb in only when visible */
  #pagefind-container:hover::-webkit-scrollbar-thumb,
  #pagefind-container:active::-webkit-scrollbar-thumb {
    opacity: 0.85;
  }

  /* Optional: slightly stronger on hover */
  #pagefind-container::-webkit-scrollbar-thumb:hover {
    opacity: 1;
  }

  /* =====================================================
     CUSTOM FOCUS GLOW
     - mouse: softer, quieter
     - keyboard: clearer, more assertive
     - Qi modulates intensity
  ===================================================== */

  .mouse-focus .pagefind-ui__search-input input:focus {
    box-shadow: 0 0 calc(10px + 20px * var(--qi))
      color-mix(in oklch, var(--search-glow) 35%, transparent);
  }

  .keyboard-focus .pagefind-ui__search-input input:focus {
    box-shadow:
      0 0 0 1px var(--search-glow),
      0 0 calc(14px + 26px * var(--qi))
        color-mix(in oklch, var(--search-glow) 55%, transparent);
  }

  /* =====================================================
     RESULTS
  ===================================================== */

  .pagefind-ui__result {
    border-radius: 14px;
    padding: 0.75rem 0.85rem;
  }

  /* =====================================================
     SCROLLBAR — TRANSPARENT TRACK
  ===================================================== */

  #pagefind-container {
    scrollbar-width: thin;
    scrollbar-color: currentColor transparent;
  }

  #pagefind-container::-webkit-scrollbar {
    width: 8px;
    background: transparent;
  }

  #pagefind-container::-webkit-scrollbar-track {
    background: transparent;
  }

  #pagefind-container::-webkit-scrollbar-thumb {
    background-color: currentColor;
    border-radius: 999px;
    opacity: 0.75;
  }

  #pagefind-container::-webkit-scrollbar-thumb:hover {
    opacity: 1;
  }

  /* =====================================================
     REMOVE ALL HIGHLIGHTS
  ===================================================== */

  .pagefind-ui ::selection,
  .pagefind-ui ::-moz-selection {
    background: transparent;
  }

  .pagefind-ui mark {
    background: transparent !important;
  }

  #backdrop {
    background: transparent !important;
    backdrop-filter: none !important;
  }

  kbd {
    line-height: 1;
  }

  /* =====================================================
     PAGEFIND CLEAR BUTTON / TOOLTIP — HARD TRANSPARENCY
  ===================================================== */

  /* Clear button itself */
  .pagefind-ui__search-clear {
    background: transparent !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  /* Tooltip container (if rendered as element) */
  .pagefind-ui__search-clear-tooltip {
    background: transparent !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  /* Tooltip text wrapper */
  .pagefind-ui__search-clear-tooltip * {
    background: transparent !important;
    box-shadow: none !important;
  }

  /* Pseudo-element tooltips */
  .pagefind-ui__search-clear::before,
  .pagefind-ui__search-clear::after {
    background: transparent !important;
    background-color: transparent !important;
    box-shadow: none !important;
    border: none !important;
  }

  /* Hover / focus / active safety */
  .pagefind-ui__search-clear:hover,
  .pagefind-ui__search-clear:focus,
  .pagefind-ui__search-clear:focus-visible,
  .pagefind-ui__search-clear:active {
    background: transparent !important;
    background-color: transparent !important;
    outline: none !important;
    box-shadow: none !important;
  }
</style>
