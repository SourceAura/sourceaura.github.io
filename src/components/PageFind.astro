---
// import { Calendar } from "@/components/ui/calendar";
import Search from "astro-pagefind/components/Search";
// import NowPlaying from "@/components/NowPlaying.astro";

const navigationPages = [
  { title: "Home", url: "/" },
  { title: "Petals", url: "/petals" },
  { title: "About", url: "/about" },
  { title: "404", url: "/404" },
];
---

<!-- PAGEFIND BACKDROP -->
<div
  transition:persist
  id="backdrop"
  class="pointer-events-none invisible fixed left-0
    top-0 z-40 flex h-screen w-full
    justify-center bg-black/60
    p-6 backdrop-blur-sm"
>
  <div
    id="pagefind-container"
    class="relative flex h-fit max-h-[80%] w-full max-w-screen-sm flex-col overflow-auto
      rounded border border-white/20 bg-transparent p-4 shadow-xl"
  >
    <Search
      id="search"
      className="pagefind-ui"
      uiOptions={{
        showImages: true,
        excerptLength: 16,
        resetStyles: false,
      }}
    />

    <div class="mt-2 flex justify-between">
      <!-- <Calendar /> -->
      <!-- <NowPlaying /> -->
    </div>

    <!-- FOOTER -->
    <div class="mt-2 flex items-baseline justify-between text-xs text-white">
      <span id="current-time" class="font-mono tabular-nums"></span>
      <span>Press <kbd class="align-baseline">Esc</kbd></span>
    </div>
  </div>
</div>

<script>
  const ase = document.getElementById("ase");
  const backdrop = document.getElementById("backdrop");

  function openPagefind() {
    const input = document.querySelector("#search input");
    backdrop?.classList.remove("invisible", "pointer-events-none");
    backdrop?.classList.add("visible");
    input?.focus();
  }

  function closePagefind() {
    const input = document.querySelector("#search input");
    if (input) input.value = "";
    backdrop?.classList.add("invisible", "pointer-events-none");
    backdrop?.classList.remove("visible");
  }

  ase?.addEventListener("click", (e) => {
    e.preventDefault();
    openPagefind();
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "/" || ((e.metaKey || e.ctrlKey) && e.key === "k")) {
      e.preventDefault();
      openPagefind();
    }
    if (e.key === "Escape") {
      closePagefind();
    }
  });

  backdrop?.addEventListener("click", (e) => {
    if (!e.target.closest("#pagefind-container")) {
      closePagefind();
    }
  });

  /* CLOCK */
  function updateTime() {
    const el = document.getElementById("current-time");
    if (!el) return;
    el.textContent = new Intl.DateTimeFormat(undefined, {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: true,
    }).format(new Date());
  }
  updateTime();
  setInterval(updateTime, 1000);
</script>

<style is:global>
  /* Enable clicks only when open */
  #backdrop.visible {
    pointer-events: auto;
  }

  /* =====================================================
     PAGEFIND: FORCE WHITE TEXT (ALL MODES)
     ===================================================== */

  :root {
    --pagefind-ui-text: #ffffff;
    --pagefind-ui-primary: #ffffff;
    --pagefind-ui-background: transparent;
    --pagefind-ui-border: rgba(255, 255, 255, 0.2);
  }

  .pagefind-ui__result-title,
  .pagefind-ui__result-title a {
    color: white;
    font-weight: 600;
  }

  .pagefind-ui__result-excerpt {
    color: white;
    opacity: 0.85;
  }

  .pagefind-ui__message,
  .pagefind-ui__search-clear {
    color: white;
    opacity: 0.7;
  }

  #search input {
    background: transparent;
    color: white;
  }

  /* =====================================================
     SCROLLBAR: ALWAYS TRANSPARENT BACKGROUND
     ===================================================== */

  /* Firefox */
  #pagefind-container {
    scrollbar-width: thin;
    scrollbar-color: rgba(255, 255, 255, 0.4) transparent;
  }

  /* WebKit (Chrome, Safari, Edge) */
  #pagefind-container::-webkit-scrollbar {
    width: 8px;
  }

  #pagefind-container::-webkit-scrollbar-track {
    background: transparent !important;
  }

  #pagefind-container::-webkit-scrollbar-corner {
    background: transparent !important;
  }

  #pagefind-container::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.35);
    border-radius: 8px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }

  #pagefind-container::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.55);
  }

  /* =====================================================
     INTERACTION POLISH
     ===================================================== */

  .pagefind-ui__result {
    animation: result-fade-in 220ms ease-out both;
  }

  @keyframes result-fade-in {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .pagefind-ui__result:hover,
  .pagefind-ui__result:focus-within {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 6px;
  }

  .pagefind-ui__result[aria-selected="true"] {
    background: rgba(255, 255, 255, 0.12);
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.4);
    border-radius: 6px;
  }

  .pagefind-ui__result-excerpt mark {
    background: transparent;
    outline: 1px solid currentColor;
    border-radius: 2px;
    mix-blend-mode: difference;
  }

  @media (prefers-reduced-motion: reduce) {
    .pagefind-ui__result {
      animation: none;
    }
  }

  kbd {
    line-height: 1;
  }

  #current-time {
    letter-spacing: 0.02em;
  }
</style>
