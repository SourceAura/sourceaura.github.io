---
/*
PageFind: displays a search section.
*/
import Search from "astro-pagefind/components/Search";
---

<div
  id="backdrop"
  class="pointer-events-none invisible fixed inset-0 z-40 bg-transparent"
>
  <div id="pagefind-shell" class="flex justify-center">
    <div
      id="pagefind-container"
      class="relative flex max-h-[70vh]
        w-full
        max-w-screen-sm flex-col overflow-auto
        bg-transparent p-4"
    >
      <Search
        id="search"
        className="pagefind-ui"
        options={{
          showImages: true,
          excerptLength: 16,
          resetStyles: false,
        }}
      />

      <div class="mt-2 flex items-baseline justify-between text-xs">
        <span id="current-time" class="font-mono tabular-nums"></span>
        <span>Press <kbd>Esc</kbd></span>
      </div>
    </div>
  </div>
</div>

<script>
  const backdrop = document.getElementById("backdrop");
  const shell = document.getElementById("pagefind-shell");
  const container = document.getElementById("pagefind-container");
  const root = document.documentElement;

  let isOpen = false;
  let scrollMemory = 0;

  let y = -14;
  let v = 0;
  let target = -14;
  let rafSpring = 0;
  let lastT = 0;

  const STIFFNESS = 520;
  const DAMPING = 38;
  const MASS = 1;

  function applySpringStyles() {
    const p = Math.max(0, Math.min(1, 1 - Math.abs(y) / 14));
    shell.style.transform = `translateY(${y}px) scale(${0.985 + 0.015 * p})`;
    shell.style.opacity = String(0.1 + 0.9 * p);
  }

  function startSpring() {
    if (rafSpring) return;
    lastT = performance.now();
    rafSpring = requestAnimationFrame(tickSpring);
  }

  function stopSpring() {
    if (!rafSpring) return;
    cancelAnimationFrame(rafSpring);
    rafSpring = 0;
  }

  function tickSpring(t) {
    const dt = Math.min((t - lastT) / 1000, 0.033);
    lastT = t;

    const F = -STIFFNESS * (y - target) - DAMPING * v;
    v += (F / MASS) * dt;
    y += v * dt;

    if (Math.abs(v) < 0.02 && Math.abs(y - target) < 0.05) {
      y = target;
      v = 0;
      applySpringStyles();
      stopSpring();
      return;
    }

    applySpringStyles();
    rafSpring = requestAnimationFrame(tickSpring);
  }

  function openPagefind() {
    isOpen = true;
    backdrop.classList.remove("invisible", "pointer-events-none");
    backdrop.classList.add("visible");
    target = 0;
    startSpring();

    requestAnimationFrame(() => {
      container.scrollTop = scrollMemory;
      document.querySelector("#search input")?.focus({ preventScroll: true });
    });
  }

  function closePagefind() {
    isOpen = false;
    scrollMemory = container.scrollTop;
    target = -14;
    startSpring();
    backdrop.classList.add("invisible", "pointer-events-none");
    backdrop.classList.remove("visible");
    const input = document.querySelector("#search input");
    if (input) input.value = "";
  }

  window.togglePagefind = () => (isOpen ? closePagefind() : openPagefind());

  document.addEventListener("keydown", (e) => {
    if (e.key === "/" || ((e.metaKey || e.ctrlKey) && e.key === "k")) {
      e.preventDefault();
      window.togglePagefind();
    }
    if (e.key === "Escape") closePagefind();
  });

  backdrop.addEventListener("click", (e) => {
    if (!e.target.closest("#pagefind-container")) closePagefind();
  });

  shell.style.marginTop = "calc(var(--header-height, 72px) + 12px)";
  applySpringStyles();

  function updateTime() {
    const el = document.getElementById("current-time");
    if (!el) return;
    el.textContent = new Intl.DateTimeFormat(undefined, {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    }).format(new Date());
  }
  updateTime();
  setInterval(updateTime, 1000);
</script>

<style is:global>
  /* =====================================================
     TEXT — FORCE PURE WHITE / BLACK BY THEME
  ===================================================== */

  html.dark .pagefind-ui,
  html.dark .pagefind-ui * {
    color: #ffffff !important;
  }

  html.light .pagefind-ui,
  html.light .pagefind-ui * {
    color: #000000 !important;
  }

  /* =====================================================
     SEARCH INPUT — ABSOLUTE TRANSPARENCY
  ===================================================== */

  .pagefind-ui__search-input {
    border-radius: 999px;
    overflow: hidden;
    background: transparent !important;
  }

  .pagefind-ui__search-input input {
    width: 100%;
    padding: 0.75rem 1.25rem;
    border-radius: 999px !important;

    /* Kill ALL background sources */
    background: transparent !important;
    background-color: transparent !important;
    background-image: none !important;

    /* Neutralize browser paint */
    box-shadow: none !important;
    -webkit-box-shadow: none !important;

    border: 1px solid currentColor;

    color: inherit;
    caret-color: currentColor;

    outline: none !important;
  }

  /* Autofill hard-kill (Chrome, Safari) */
  .pagefind-ui__search-input input:-webkit-autofill,
  .pagefind-ui__search-input input:-webkit-autofill:hover,
  .pagefind-ui__search-input input:-webkit-autofill:focus,
  .pagefind-ui__search-input input:-webkit-autofill:active {
    -webkit-box-shadow: 0 0 0 1000px transparent inset !important;
    -webkit-text-fill-color: currentColor !important;
    transition: background-color 9999s ease-out;
  }

  /* Focus glow (border only, no fill) */
  .pagefind-ui__search-input input:focus {
    border-color: var(--accent);
    box-shadow:
      0 0 0 1px var(--accent),
      0 0 18px;
  }

  /* =====================================================
     RESULTS
  ===================================================== */

  .pagefind-ui__result {
    border-radius: 14px;
    padding: 0.75rem 0.85rem;
  }
  /* =====================================================
     REMOVE NATIVE FOCUS OUTLINE (BLUE RING)
  ===================================================== */

  .pagefind-ui__search-input input {
    outline: none !important;
  }

  .pagefind-ui__search-input input:focus-visible {
    outline: none !important;
  }

  /* =====================================================
     SCROLLBAR — TRANSPARENT TRACK, THEME COLOR THUMB
  ===================================================== */

  #pagefind-container {
    scrollbar-width: thin;
    scrollbar-color: currentColor transparent;
  }

  #pagefind-container::-webkit-scrollbar {
    width: 8px;
    background: transparent;
  }

  #pagefind-container::-webkit-scrollbar-track {
    background: transparent;
  }

  #pagefind-container::-webkit-scrollbar-thumb {
    background-color: currentColor;
    border-radius: 999px;
    opacity: 0.75;
  }

  #pagefind-container::-webkit-scrollbar-thumb:hover {
    opacity: 1;
  }

  kbd {
    line-height: 1;
  }

  #backdrop {
    background: transparent !important;
    backdrop-filter: none !important;
  }
</style>
