---
/**
 * Qi: visualizer
 * Theme-aware (matches Quasar stars)
 */
---

<div id="qi-root">
  <div class="qi-core">
    <div class=""></div>
    <canvas id="qi-vis"></canvas>
  </div>
</div>

<style>
  #qi-root {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    pointer-events: none;
    z-index: 0;
  }

  .qi-core {
    position: relative;
    width: 180px;
    height: 180px;
    border-radius: 9999px;
  }

  #qi-vis {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }
</style>

<script>
  const canvas = document.getElementById("qi-vis");
  const ctx = canvas.getContext("2d");

  const BINS = 240;
  const audio = new Float32Array(BINS);

  let isLight = false;

  function updateTheme() {
    isLight = document.documentElement.classList.contains("light");
  }

  updateTheme();

  new MutationObserver(updateTheme).observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["class"],
  });

  function resize() {
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    const size = canvas.clientWidth;
    canvas.width = size * dpr;
    canvas.height = size * dpr;
    ctx.setTransform(dpr, 0, 0, dpr, size / 2, size / 2);
  }

  resize();
  window.addEventListener("resize", resize);

  function updateAudio() {
    for (let i = 0; i < audio.length; i++) {
      audio[i] = Math.max(
        0.02,
        Math.min(1, audio[i] + (Math.random() - 0.5) * 0.025),
      );
    }
  }

  function draw() {
    ctx.clearRect(
      -canvas.width,
      -canvas.height,
      canvas.width * 2,
      canvas.height * 2,
    );

    ctx.fillStyle = isLight ? "rgba(0,0,0,0.7)" : "rgba(255,255,255,0.7)";

    const step = (Math.PI * 2) / audio.length;

    ctx.save();
    for (let i = 0; i < audio.length; i++) {
      ctx.rotate(step);
      ctx.fillRect(-1, 60, 2, audio[i] * 42);
    }
    ctx.restore();
  }

  function frame() {
    updateAudio();
    draw();
    requestAnimationFrame(frame);
  }

  frame();
</script>
