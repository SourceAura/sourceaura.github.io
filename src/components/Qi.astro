<div id="qi-root">
  <canvas id="qi-vis"></canvas>
</div>

<style>
  #qi-root {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }

  #qi-vis {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }
</style>

<script>
  const canvas = document.getElementById("qi-vis");
  const ctx = canvas.getContext("2d");

  const BINS = 240;
  const audio = new Float32Array(BINS);

  let isLight = false;

  function updateTheme() {
    isLight = document.documentElement.classList.contains("light");
  }

  updateTheme();
  new MutationObserver(updateTheme).observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["class"],
  });

  function resize() {
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    const rect = canvas.getBoundingClientRect();

    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  resize();
  window.addEventListener("resize", resize);
  window.addEventListener("orientationchange", resize);

  function updateAudio() {
    for (let i = 0; i < audio.length; i++) {
      audio[i] = Math.max(
        0.02,
        Math.min(1, audio[i] + (Math.random() - 0.5) * 0.025),
      );
    }
  }

  function draw() {
    const rect = canvas.getBoundingClientRect();
    const cx = rect.width / 2;
    const cy = rect.height / 2;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(cx, cy);

    ctx.fillStyle = isLight ? "rgba(0,0,0,0.7)" : "rgba(255,255,255,0.7)";

    const step = (Math.PI * 2) / audio.length;

    for (let i = 0; i < audio.length; i++) {
      ctx.rotate(step);
      ctx.fillRect(-1, 60, 2, audio[i] * 42);
    }

    ctx.restore();
  }

  function frame() {
    updateAudio();
    draw();
    requestAnimationFrame(frame);
  }

  frame();
</script>
