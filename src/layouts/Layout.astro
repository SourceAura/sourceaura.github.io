---
import { SITE } from "@consts"
import Qi from "@/components/Qi.astro"
import Head from "@components/Head.astro"
import Quasar from "@components/Quasar.astro"
import Header from "@components/Header.astro"
import Footer from "@components/Footer.astro"
import PageFind from "@components/PageFind.astro"

// ðŸ‘‡ optional navigation props
const { title, description, prev, next } = Astro.props
---

<!doctype html>
<html lang="en">
  <head>
    <Head title={`${title} | ${SITE.TITLE}`} description={description} />
  </head>

  <body data-route={Astro.props["data-route"]}>

    <Quasar />
    <Qi />
    <Header />

    <main>
        <!-- Euthymia -->
      <slot />
      <!--  -->
    </main>

    <Footer />
    <PageFind />

    {prev || next ? (
      <script
        define:vars={{ prev, next }}
        type="module"
      >
        import { attachPostNavigation } from "/src/utils/postNavigator"

        attachPostNavigation({ prev, next })
      </script>
    ) : null}

    <script is:inline type="module">
      import {
        mountGestures,
        registerGestureHandler,
      } from "/src/utils/gestures.ts";

      mountGestures();

      registerGestureHandler((gesture) => {
        const petalShell = document.getElementById("petal-shell");
        const petalsOpen = petalShell?.hasAttribute("data-petals-open");

        const isPost = !!document.querySelector("article[data-orb]");

        if (gesture === "pinch-in") {
          // Post â†’ petals
          if (isPost) {
            history.back();
            return;
          }

          // Petals â†’ home
          if (petalsOpen) {
            window.dispatchEvent(new Event("qi:toggle-petals"));
            return;
          }

          // Anywhere â†’ home
          location.href = "/";
        }
      });
    </script>

  </body>
</html>

<script is:inline type="module">
  import {
    mountGestures,
    registerGestureHandler,
  } from "/src/utils/gestures.ts";

  mountGestures();

  registerGestureHandler((gesture) => {
    const petalShell = document.getElementById("petal-shell");
    const petalsOpen = petalShell?.hasAttribute("data-petals-open");

    const route = document.body.dataset.route;

    if (gesture === "pinch-in") {
      // Post â†’ petals
      if (route === "post") {
        history.back();
        return;
      }

      // Petals â†’ home
      if (petalsOpen) {
        window.dispatchEvent(new Event("qi:toggle-petals"));
        return;
      }

      // Anywhere â†’ home
      location.href = "/";
    }
  });
</script>
