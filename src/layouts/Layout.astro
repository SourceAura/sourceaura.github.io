---
import { SITE } from "@consts"
import Qi from "@/components/Qi.astro"
import Head from "@components/Head.astro"
import Quasar from "@components/Quasar.astro"
import Header from "@components/Header.astro"
import Footer from "@components/Footer.astro"
import PageFind from "@components/PageFind.astro"

const { title, description, prev, next } = Astro.props
---

<!doctype html>
<html lang="en">
  <head>
    <Head title={`${title} | ${SITE.TITLE}`} description={description} />
  </head>

  <body data-route={Astro.props["data-route"]}>

    <Quasar />
    <Qi />
    <Header />

    <main>
      <slot />
    </main>

    <Footer />
    <PageFind />

    {prev || next ? (
      <script define:vars={{ prev, next }} type="module">
        import { attachPostNavigation } from "/src/utils/postNavigator"
        attachPostNavigation({ prev, next })
      </script>
    ) : null}

    <!-- ✅ Ase bootstrap (browser-only, guaranteed) -->
    <script is:inline type="module">
      import { initAseClient } from "/src/lib/ase-client.js";

      console.log("[ASE] bootstrap starting");
      initAseClient();
    </script>

    <!-- Existing gesture script (unchanged) -->
    <script is:inline type="module">
      import {
        mountGestures,
        registerGestureHandler,
      } from "/src/utils/gestures.ts";

      mountGestures();

      registerGestureHandler((gesture) => {
        const petalShell = document.getElementById("petal-shell");
        const petalsOpen = petalShell?.hasAttribute("data-petals-open");
        const isPost = !!document.querySelector("article[data-orb]");

        if (gesture === "pinch-in") {
          if (isPost) {
            history.back();
            return;
          }
          if (petalsOpen) {
            window.dispatchEvent(new Event("qi:toggle-petals"));
            return;
          }
          location.href = "/";
        }
      });
    </script>

  </body>
</html>

<!-- Ase Debug Hud -->
<!-- <script>
const tick = Math.floor(performance.now() / 500);

  function startAseDebugHud() {
    const debugEl = document.getElementById("ase-debug");
    if (!debugEl) return;

    setInterval(() => {
      const s = window.__aseSession;
      if (!s) return;

      const now = performance.now();
      const timeOnSite = (now - s.startTime) / 1000;

      const avgScrollVelocity =
        s.scrollSamples.length
          ? s.scrollSamples.reduce((a, b) => a + b, 0) / s.scrollSamples.length
          : 0;

      const idleRatio =
        s.idleTime / Math.max(now - s.startTime, 1);

      debugEl.innerHTML = `
<div style="opacity:.7;margin-bottom:6px;">Ase · session</div>
time        ${timeOnSite.toFixed(1)}s<br/>
scroll vel  ${avgScrollVelocity.toFixed(3)}<br/>
idle ratio  ${idleRatio.toFixed(2)}<br/>
interacts   ${s.interactions}<br/>
ase-wake    ${getComputedStyle(document.documentElement)
  .getPropertyValue("--ase-wake")
  .trim()}
      `;
    }, 500);
  }

  // wait until Ase client initializes
  window.addEventListener("load", () => {
    setTimeout(startAseDebugHud, 800);
  });

  // Toggle with `
  let aseDebugVisible = true;
  window.addEventListener("keydown", e => {
    if (e.key === "`") {
      const el = document.getElementById("ase-debug");
      if (!el) return;
      aseDebugVisible = !aseDebugVisible;
      el.style.display = aseDebugVisible ? "block" : "none";
    }
  });
</script> -->



<!-- Styles Below -->

<style>

#ase-debug {
  position: fixed;
  top: 12px;
  left: 12px;

  min-width: 220px;
  max-width: 260px;

  font-family: ui-monospace, monospace;
  font-size: 11px;
  line-height: 1.5;

  padding: 10px 12px;

  background: transparent !important;
  color: white;

  border-radius: 6px;

  z-index: 9999;
  pointer-events: none;

  backdrop-filter: blur(6px);

  box-shadow:
    0 4px 16px rgba(0, 0, 0, 0.25),
    inset 0 0 0 1px rgba(255, 255, 255, 0.08);

  animation: ase-debug-fade-in 240ms ease-out;
}

html.light #ase-debug {
  background: rgba(255, 255, 255, 0.75);
  color: black;

  box-shadow:
    0 4px 16px rgba(0, 0, 0, 0.12),
    inset 0 0 0 1px rgba(0, 0, 0, 0.08);
}

@keyframes ase-debug-fade-in {
  from {
    opacity: 0;
    transform: translateY(-4px);
  }
  to {
    opacity: 1;
    transform: none;
  }
}


</style>


<div id="ase-debug"></div>
