{"version":3,"file":"_image.astro.mjs","sources":["../../../../node_modules/astro/dist/assets/utils/etag.js","../../../../node_modules/astro/dist/assets/endpoint/generic.js"],"sourcesContent":["const fnv1a52 = (str) => {\n  const len = str.length;\n  let i = 0, t0 = 0, v0 = 8997, t1 = 0, v1 = 33826, t2 = 0, v2 = 40164, t3 = 0, v3 = 52210;\n  while (i < len) {\n    v0 ^= str.charCodeAt(i++);\n    t0 = v0 * 435;\n    t1 = v1 * 435;\n    t2 = v2 * 435;\n    t3 = v3 * 435;\n    t2 += v0 << 8;\n    t3 += v1 << 8;\n    t1 += t0 >>> 16;\n    v0 = t0 & 65535;\n    t2 += t1 >>> 16;\n    v1 = t1 & 65535;\n    v3 = t3 + (t2 >>> 16) & 65535;\n    v2 = t2 & 65535;\n  }\n  return (v3 & 15) * 281474976710656 + v2 * 4294967296 + v1 * 65536 + (v0 ^ v3 >> 4);\n};\nconst etag = (payload, weak = false) => {\n  const prefix = weak ? 'W/\"' : '\"';\n  return prefix + fnv1a52(payload).toString(36) + payload.length.toString(36) + '\"';\n};\nexport {\n  etag,\n  fnv1a52\n};\n","import { imageConfig } from \"astro:assets\";\nimport { isRemotePath } from \"@astrojs/internal-helpers/path\";\nimport * as mime from \"mrmime\";\nimport { getConfiguredImageService } from \"../internal.js\";\nimport { etag } from \"../utils/etag.js\";\nimport { isRemoteAllowed } from \"../utils/remotePattern.js\";\nasync function loadRemoteImage(src, headers) {\n  try {\n    const res = await fetch(src, {\n      // Forward all headers from the original request\n      headers\n    });\n    if (!res.ok) {\n      return void 0;\n    }\n    return await res.arrayBuffer();\n  } catch {\n    return void 0;\n  }\n}\nconst GET = async ({ request }) => {\n  try {\n    const imageService = await getConfiguredImageService();\n    if (!(\"transform\" in imageService)) {\n      throw new Error(\"Configured image service is not a local service\");\n    }\n    const url = new URL(request.url);\n    const transform = await imageService.parseURL(url, imageConfig);\n    if (!transform?.src) {\n      throw new Error(\"Incorrect transform returned by `parseURL`\");\n    }\n    let inputBuffer = void 0;\n    const isRemoteImage = isRemotePath(transform.src);\n    const sourceUrl = isRemoteImage ? new URL(transform.src) : new URL(transform.src, url.origin);\n    if (isRemoteImage && isRemoteAllowed(transform.src, imageConfig) === false) {\n      return new Response(\"Forbidden\", { status: 403 });\n    }\n    inputBuffer = await loadRemoteImage(sourceUrl, isRemoteImage ? new Headers() : request.headers);\n    if (!inputBuffer) {\n      return new Response(\"Not Found\", { status: 404 });\n    }\n    const { data, format } = await imageService.transform(\n      new Uint8Array(inputBuffer),\n      transform,\n      imageConfig\n    );\n    return new Response(data, {\n      status: 200,\n      headers: {\n        \"Content-Type\": mime.lookup(format) ?? `image/${format}`,\n        \"Cache-Control\": \"public, max-age=31536000\",\n        ETag: etag(data.toString()),\n        Date: (/* @__PURE__ */ new Date()).toUTCString()\n      }\n    });\n  } catch (err) {\n    console.error(\"Could not process image request:\", err);\n    return new Response(`Server Error: ${err}`, { status: 500 });\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":";;;;;AAAA,KAAA,CAAM,OAAO,CAAA,CAAA,CAAG,CAAC,GAAG,CAAK,CAAA,CAAA,CAAA,CAAA,CAAA;AACzB,CAAA,CAAE,MAAM,GAAG,CAAA,CAAA,CAAG,GAAG,CAAC,MAAM,CAAC;AACzB,CAAA,CAAE,IAAI,CAAC,CAAA,CAAA,CAAG,CAAC,CAAA,CAAE,EAAE,CAAG,CAAA,CAAA,CAAC,CAAE,CAAA,EAAE,GAAG,IAAI,CAAA,CAAE,EAAE,CAAA,CAAA,CAAG,CAAC,CAAE,CAAA,EAAE,CAAG,CAAA,CAAA,KAAK,EAAE,EAAE,CAAA,CAAA,CAAG,CAAC,CAAA,CAAE,EAAE,CAAG,CAAA,CAAA,KAAK,CAAE,CAAA,EAAE,GAAG,CAAC,CAAA,CAAE,EAAE,CAAA,CAAA,CAAG,KAAK,CAAC;AAC3F,CAAA,CAAE,KAAO,CAAA,CAAA,CAAC,CAAG,CAAA,CAAA,GAAG,CAAE,CAAA,CAAA;AAClB,CAAI,CAAA,CAAA,CAAA,EAAE,IAAI,GAAG,CAAC,UAAU,CAAC,CAAC,CAAE,CAAA,CAAC,CAAC;AAC9B,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,GAAG,CAAC;AAClB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,GAAG,CAAC;AAClB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,GAAG,CAAC;AAClB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,GAAG,CAAC;AAClB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAI,CAAC,CAAC;AAClB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAI,CAAC,CAAC;AAClB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAA,CAAK,EAAE,CAAC;AACpB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,KAAK,CAAC;AACpB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAA,CAAA,CAAK,EAAE,CAAC;AACpB,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,KAAK,CAAC;AACpB,CAAI,CAAA,CAAA,CAAA,EAAE,CAAG,CAAA,CAAA,EAAE,CAAI,CAAA,CAAA,CAAA,EAAE,KAAK,EAAE,CAAC,CAAG,CAAA,CAAA,KAAK,CAAC;AAClC,CAAA,CAAA,CAAA,CAAI,EAAE,CAAA,CAAA,CAAG,EAAE,CAAA,CAAA,CAAG,KAAK,CAAC;AACpB,CAAG,CAAA,CAAA;AACH,CAAE,CAAA,MAAA,CAAO,CAAC,EAAE,CAAA,CAAA,CAAG,EAAE,CAAI,CAAA,CAAA,CAAA,eAAe,CAAG,CAAA,CAAA,EAAE,CAAG,CAAA,CAAA,UAAU,GAAG,EAAE,CAAA,CAAA,CAAG,KAAK,CAAI,CAAA,CAAA,CAAA,EAAE,GAAG,EAAE,CAAA,CAAA,CAAA,CAAI,CAAC,CAAC,CAAC;AACrF,CAAC,CAAC;AACF,KAAM,CAAA,IAAI,GAAG,CAAC,OAAO,EAAE,IAAI,CAAA,CAAA,CAAG,KAAK,CAAK,CAAA,CAAA,CAAA,CAAA,CAAA;AACxC,CAAE,CAAA,KAAA,CAAM,MAAM,CAAG,CAAA,CAAA,IAAI,GAAG,CAAK,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAG,GAAG,CAAC;AACpC,CAAE,CAAA,MAAA,CAAO,MAAM,CAAG,CAAA,CAAA,OAAO,CAAC,OAAO,CAAC,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAG,CAAA,CAAA,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAG,CAAA,CAAA,CAAA,CAAA,CAAG,CAAC;AACpF,CAAC,CAAA;;ACjBD,KAAA,CAAA,QAAA,CAAe,eAAe,CAAC,GAAG,CAAA,CAAE,OAAO,CAAE,CAAA,CAAA;AAC7C,CAAA,CAAE,GAAI,CAAA,CAAA;AACN,CAAA,CAAA,CAAA,CAAI,MAAM,GAAG,CAAA,CAAA,CAAG,MAAM,KAAK,CAAC,GAAG,CAAE,CAAA,CAAA;AACjC,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,OAAA,CAAA,GAAA,CAAA,OAAA,CAAA,IAAA,CAAA,GAAA,CAAA,QAAA,CAAA,OAAA;AACA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,OAAO;AACb,CAAA,CAAA,CAAA,CAAA,CAAK,CAAC,CAAC;AACP,CAAA,CAAA,CAAA,CAAI,EAAI,CAAA,CAAA,CAAC,GAAG,CAAC,EAAE,CAAE,CAAA,CAAA;AACjB,CAAM,CAAA,CAAA,CAAA,CAAA,CAAA,MAAA,CAAO,IAAK,CAAA,CAAC,CAAC;AACpB,CAAK,CAAA,CAAA,CAAA,CAAA;AACL,CAAA,CAAA,CAAA,CAAI,OAAO,KAAM,CAAA,GAAG,CAAC,WAAW,EAAE,CAAC;AACnC,CAAA,CAAA,CAAG,CAAC,KAAM,CAAA,CAAA;AACV,CAAI,CAAA,CAAA,CAAA,MAAA,CAAO,IAAK,CAAA,CAAC,CAAC;AAClB,CAAG,CAAA,CAAA;AACH,CAAC;AACD,KAAA,CAAM,GAAG,CAAG,CAAA,CAAA,KAAA,CAAA,CAAO,CAAE,CAAA,OAAO,EAAE,CAAK,CAAA,CAAA,CAAA,CAAA,CAAA;AACnC,CAAA,CAAE,GAAI,CAAA,CAAA;AACN,CAAA,CAAA,CAAA,CAAI,MAAM,YAAY,CAAA,CAAA,CAAG,KAAM,CAAA,yBAAyB,EAAE,CAAC;AAC3D,CAAA,CAAA,CAAA,CAAI,IAAI,CAAE,CAAA,CAAA,SAAA,CAAW,CAAI,EAAA,CAAA,YAAY,CAAC,CAAE,CAAA,CAAA;AACxC,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,MAAM,GAAI,CAAA,KAAK,CAAC,CAAA,UAAA,CAAA,KAAA,CAAA,OAAA,CAAA,EAAA,CAAA,GAAA,CAAA,CAAA,CAAA,KAAA,CAAA,OAAA,CAAiD,CAAC,CAAC;AACzE,CAAK,CAAA,CAAA,CAAA,CAAA;AACL,CAAI,CAAA,CAAA,CAAA,KAAA,CAAM,GAAG,CAAA,CAAA,CAAG,GAAI,CAAA,GAAG,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;AACrC,CAAA,CAAA,CAAA,CAAI,KAAM,CAAA,SAAS,CAAG,CAAA,CAAA,KAAA,CAAM,YAAY,CAAC,QAAQ,CAAC,GAAG,CAAA,CAAE,WAAW,CAAC,CAAC;AACpE,CAAA,CAAA,CAAA,CAAI,EAAI,CAAA,CAAA,CAAC,SAAS,CAAA,CAAE,GAAG,CAAE,CAAA,CAAA;AACzB,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,MAAM,GAAI,CAAA,KAAK,CAAC,CAAA,SAAA,CAAA,SAAA,CAAA,QAAA,CAAA,EAAA,CAAA,CAAA,QAAA,CAAA,CAA4C,CAAC,CAAC;AACpE,CAAK,CAAA,CAAA,CAAA,CAAA;AACL,CAAA,CAAA,CAAA,CAAI,GAAI,CAAA,WAAW,CAAG,CAAA,CAAA,IAAA,CAAK,CAAC,CAAC;AAC7B,CAAI,CAAA,CAAA,CAAA,KAAA,CAAM,aAAa,CAAG,CAAA,CAAA,YAAY,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;AACtD,CAAI,CAAA,CAAA,CAAA,KAAA,CAAM,SAAS,CAAA,CAAA,CAAG,aAAa,CAAA,CAAA,CAAG,IAAI,GAAG,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,GAAI,CAAA,GAAG,CAAC,SAAS,CAAC,GAAG,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC;AAClG,CAAA,CAAA,CAAA,CAAI,EAAI,CAAA,CAAA,aAAa,CAAI,CAAA,CAAA,CAAA,eAAe,CAAC,SAAS,CAAC,GAAG,CAAE,CAAA,WAAW,CAAC,CAAA,CAAA,CAAA,CAAA,CAAK,KAAK,CAAE,CAAA,CAAA;AAChF,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,MAAO,CAAA,GAAA,CAAI,QAAQ,CAAC,CAAW,SAAA,CAAA,CAAA,CAAE,CAAE,CAAA,MAAM,CAAE,CAAA,GAAG,CAAE,CAAA,CAAC,CAAC;AACxD,CAAK,CAAA,CAAA,CAAA,CAAA;AACL,CAAA,CAAA,CAAA,CAAI,WAAW,CAAG,CAAA,CAAA,KAAA,CAAM,eAAe,CAAC,SAAS,CAAE,CAAA,aAAa,CAAG,CAAA,CAAA,GAAA,CAAI,OAAO,CAAE,CAAA,CAAA,CAAA,CAAG,OAAO,CAAC,OAAO,CAAC,CAAC;AACpG,CAAI,CAAA,CAAA,CAAA,EAAA,CAAA,CAAI,CAAC,WAAW,CAAE,CAAA,CAAA;AACtB,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,MAAO,CAAA,GAAA,CAAI,QAAQ,CAAC,CAAW,GAAA,CAAA,KAAA,CAAA,CAAA,CAAE,CAAE,CAAA,MAAM,CAAE,CAAA,GAAG,CAAE,CAAA,CAAC,CAAC;AACxD,CAAK,CAAA,CAAA,CAAA,CAAA;AACL,CAAI,CAAA,CAAA,CAAA,KAAA,CAAM,CAAE,CAAA,IAAI,CAAE,CAAA,MAAM,EAAE,CAAG,CAAA,CAAA,KAAA,CAAM,YAAY,CAAC,SAAS,CAAA;AACzD,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,GAAI,CAAA,UAAU,CAAC,WAAW,CAAC,CAAA;AACjC,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,SAAS,CAAA;AACf,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,WAAW;AACjB,CAAA,CAAA,CAAA,CAAA,CAAK,CAAC;AACN,CAAA,CAAA,CAAA,CAAI,MAAO,CAAA,GAAA,CAAI,QAAQ,CAAC,IAAI,CAAE,CAAA,CAAA;AAC9B,CAAM,CAAA,CAAA,CAAA,CAAA,CAAA,MAAM,EAAE,GAAG,CAAA;AACjB,CAAA,CAAA,CAAA,CAAA,CAAA,CAAM,OAAO,CAAE,CAAA,CAAA;AACf,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAQ,CAAc,OAAA,CAAA,IAAA,CAAA,CAAA,CAAE,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAA,CAAA,CAAA,CAAI,CAAC,KAAA,CAAM,CAAE,CAAA,MAAM,CAAC,CAAC,CAAA;AAChE,CAAQ,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,KAAA,CAAA,OAAA,CAAe,EAAE,CAA0B,MAAA,CAAA,CAAA,GAAA,CAAA,GAAA,CAAA,QAAA,CAAA,CAAA;AACnD,CAAQ,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,IAAI,EAAE,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAA;AACnC,CAAQ,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA,IAAI,EAAE,CAAiB,CAAA,CAAA,CAAA,CAAA,QAAA,CAAA,CAAA,CAAA,CAAA,GAAA,CAAI,IAAI,CAAE,CAAA,CAAA,CAAE,WAAW,CAAE,CAAA;AACxD,CAAO,CAAA,CAAA,CAAA,CAAA,CAAA,CAAA;AACP,CAAA,CAAA,CAAA,CAAA,CAAK,CAAC,CAAC;AACP,CAAG,CAAA,CAAA,CAAC,KAAO,CAAA,CAAA,GAAG,CAAE,CAAA,CAAA;AAChB,CAAI,CAAA,CAAA,CAAA,OAAO,CAAC,KAAK,CAAC,kCAAkC,CAAE,CAAA,GAAG,CAAC,CAAC;AAC3D,CAAA,CAAA,CAAA,CAAI,OAAO,GAAI,CAAA,QAAQ,CAAC,CAAC,cAAc,CAAE,CAAA,GAAG,CAAC,CAAC,EAAE,CAAE,CAAA,MAAM,EAAE,GAAG,CAAA,CAAE,CAAC,CAAC;AACjE,CAAG,CAAA,CAAA;AACH,CAAC,CAAA;;;;;;;;;","x_google_ignoreList":[0,1]}